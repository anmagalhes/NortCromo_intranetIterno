<script>
  $(function () {
    $('#tabs').tabs();
  });
</script>
<div id="tabs">
  <ul>
    <li><a href="#tabs-1" onclick="ler_dados_clientes()">Cliente</a></li>
    <li><a href="#tabs-2" onclick="ler_dados_produtos();">Produtos</a></li>
    <li>
      <a href="#tabs-3" onclick="ler_dados_produtos_escolhidos()">Resumo</a>
    </li>
  </ul>
  <div id="tabs-1">
    <div id="meus_inputs_escolher_cliente"></div>
    <button onclick="adicionar_cliente_escolhido()">Adicionar</button>
    <div class="campo_pesquisa">
      <label>Pesquisar</label>
      <input type="text" id="pesquisar_cliente_escolher" />
    </div>
    <button onclick="escolhe_cliente()">Escolher</button>
    <table
      id="tabela_cliente_escolher"
      class="display nowrap"
      style="width: 100%"
    >
      <thead>
        <tr id="cabecalho_cliente_escolher"></tr>
      </thead>
    </table>
  </div>
  <div id="tabs-2">
    <div id="meus_inputs_escolher_produto"></div>
    <button onclick="adicionar_produto_escolhido()">Adicionar</button>
    <div class="campo_pesquisa">
      <label>Pesquisar</label>
      <input type="text" id="pesquisar_produto_escolher" />
    </div>
    <button onclick="escolher_produto()">Escolher</button>
    <table
      id="tabela_produto_escolher"
      class="display nowrap"
      style="width: 100%"
    >
      <thead>
        <tr id="cabecalho_produto_escolher"></tr>
      </thead>
    </table>
  </div>
  <div id="tabs-3">
    <br />
    <div>
      <button onclick="lancar_venda()">Lançar Venda</button>
    </div>
    <br />
    <br />
    <div>
      <label>ID Cliente</label>
      <input type="text" id="id_cliente_escolhido" disabled />
    </div>
    <div>
      <label>Cliente</label>
      <input type="text" id="cliente_escolhido" disabled />
    </div>
    <div>
      <button onclick="escolher_produto_resumo()">Escolher</button>
      <button onclick="excluir_produto_escolhido()">Excluir</button>
      <table
        id="tabela_produto_escolhidos"
        class="display nowrap"
        style="width: 100%"
      >
        <thead>
          <tr id="cabecalho_produto_escolhidos"></tr>
        </thead>
      </table>
    </div>
  </div>
</div>
<script>
  $(document).ready(function () {
    ler_dados_clientes();
    $('#qtd').on('input', function () {
      $(this).val(function (_, currentValue) {
        var newValue = currentValue.replace(
          /,/g,
          function (match, offset, input) {
            return offset === input.lastIndexOf(',') ? match : '';
          }
        );
        return newValue.replace(/[^0-9,]/g, '');
      });
    });
  });

  function lancar_venda() {
    var id_cliente_escolhido = document.getElementById(
      'id_cliente_escolhido'
    ).value;
    var cliente_escolhido = document.getElementById('cliente_escolhido').value;

    var all_data = {
      id_cliente_escolhido: id_cliente_escolhido,
      cliente_escolhido: cliente_escolhido,
      produtos_escolhidos: produtos_escolhidos,
      id_da_venda_ref: id_da_venda_ref,
    };

    $.ajax({
      url: my_url() + 'lancar_venda',
      data: JSON.stringify(all_data),
      contentType: 'application/json',
      type: 'POST',
    }).done(function (data) {
      alert(data.retorno);
    });
  }

  function excluir_produto_escolhido() {
    var tabela_produto = document.getElementById('tabela_produto_escolhidos');

    var o_que_foi_selecionado =
      tabela_produto.getElementsByClassName('selected')[0];

    var elemento_pai = tabela_produto.getElementsByTagName('tbody')[0];

    var todas_as_linhas = Array.from(elemento_pai.childNodes);

    var posicao = todas_as_linhas.indexOf(o_que_foi_selecionado);

    produtos_escolhidos.splice(posicao, 1);
    ler_dados_produtos_escolhidos();
  }

  function adicionar_produto_escolhido() {
    var input_produto = document.getElementsByClassName('input_produto');
    var qts_inputs = input_produto.length;
    var all_data = [];

    for (var i = 0; i < qts_inputs; i++) {
      all_data.push(input_produto[i].value);
    }

    if (produto_para_alterar == null) {
      produtos_escolhidos.push(all_data);
      alert('Produto Adicionado');
    } else {
      produtos_escolhidos[produto_para_alterar] = all_data;
      alert('Produto Alterado');
    }
  }

  function adicionar_cliente_escolhido() {
    var id = document.getElementById('Id').value;
    var nome_cliente =
      document.getElementsByClassName('input_cliente')[1].value;

    document.getElementById('id_cliente_escolhido').value = id;
    document.getElementById('cliente_escolhido').value = nome_cliente;

    alert('Cliente Escolhido');
  }

  function escolhe_cliente() {
    var tabela_cliente = document.getElementById('tabela_cliente_escolher');

    var o_que_foi_selecionado =
      tabela_cliente.getElementsByClassName('selected')[0];

    var tds = o_que_foi_selecionado.getElementsByTagName('td');
    var qtd_tds = tds.length;

    for (var i = 0; i < qtd_tds; i++) {
      document.getElementsByClassName('input_cliente')[i].value =
        tds[i].innerHTML;
    }
  }

  function escolher_produto() {
    var tabela_produto = document.getElementById('tabela_produto_escolher');

    var o_que_foi_selecionado =
      tabela_produto.getElementsByClassName('selected')[0];

    var tds = o_que_foi_selecionado.getElementsByTagName('td');
    var qtd_tds = tds.length;

    for (var i = 0; i < qtd_tds; i++) {
      document.getElementsByClassName('input_produto')[i].value =
        tds[i].innerHTML;
    }

    document.getElementById('Valor Total').value = '';
    document.getElementById('qtd').value = '';
  }

  function escolher_produto_resumo() {
    var tabela_produto = document.getElementById('tabela_produto_escolhidos');

    var o_que_foi_selecionado =
      tabela_produto.getElementsByClassName('selected')[0];

    var elemento_pai = tabela_produto.getElementsByTagName('tbody')[0];

    var todas_as_linhas = Array.from(elemento_pai.childNodes);

    var posicao = todas_as_linhas.indexOf(o_que_foi_selecionado);

    produto_para_alterar = posicao;

    document.getElementById('ui-id-2').click();
  }

  function ler_dados_produtos_escolhidos() {
    $.ajax({
      url: my_url() + 'ler_dados_produtos',
      type: 'POST',
    }).done(function (data) {
      let dados = data.retorno;
      let cabecalho = dados[0];
      gera_cabecalho_produto_escolhidos(cabecalho);

      dados = produtos_escolhidos;

      try {
        $('#tabela_produto_escolhidos').DataTable().clear();
        $('#tabela_produto_escolhidos').DataTable().destroy();
      } catch (e) {}

      const datatable = new DataTable('#tabela_produto_escolhidos', {
        data: dados,
        deferRender: true,
        scrollCollapse: true,
        scroller: true,
        scrollY: 200,
      });

      $('#tabela_produto_escolhidos tbody').on('click', 'tr', function () {
        var row = datatable.row(this);

        if (row.data()) {
          var selectedRows = datatable.rows('.selected');

          if (row.node().classList.contains('selected')) {
            row.node().classList.remove('selected');
          } else {
            selectedRows.nodes().to$().removeClass('selected');
            row.node().classList.add('selected');
          }
        }
      });

      $('#pesquisar_produto_escolhidos').on('input', function () {
        var valor_para_pesquisar = $(this).val();
        datatable.search(valor_para_pesquisar).draw();
      });

      if (parte_cliente.length > 0) {
        document.getElementById('id_cliente_escolhido').value =
          parte_cliente[0];
        document.getElementById('cliente_escolhido').value = parte_cliente[1];
      }
    });
  }

  function gera_cabecalho_produto_escolhidos(cabecalho) {
    var cabecalhoLen = cabecalho.length;

    for (var i = 0; i < cabecalhoLen; i++) {
      var item_do_cabecalho = `<th>` + cabecalho[i] + `</th>`;
      document.getElementById('cabecalho_produto_escolhidos').innerHTML =
        document.getElementById('cabecalho_produto_escolhidos').innerHTML +
        item_do_cabecalho;
    }

    var item_do_cabecalho = `<th>` + 'qtd' + `</th>`;
    document.getElementById('cabecalho_produto_escolhidos').innerHTML =
      document.getElementById('cabecalho_produto_escolhidos').innerHTML +
      item_do_cabecalho;

    var item_do_cabecalho = `<th>` + 'Valor Total' + `</th>`;
    document.getElementById('cabecalho_produto_escolhidos').innerHTML =
      document.getElementById('cabecalho_produto_escolhidos').innerHTML +
      item_do_cabecalho;
  }

  function ler_dados_produtos() {
    $.ajax({
      url: my_url() + 'ler_dados_produtos',
      type: 'POST',
    }).done(function (data) {
      let dados = data.retorno;
      let cabecalho = dados[0];

      gera_cabecalho_produto(cabecalho);
      dados = dados.slice(1, dados.length);

      try {
        $('#tabela_produto_escolher').DataTable().clear();
        $('#tabela_produto_escolher').DataTable().destroy();
      } catch (e) {}

      const datatable = new DataTable('#tabela_produto_escolher', {
        data: dados,
        deferRender: true,
        scrollCollapse: true,
        scroller: true,
        scrollY: 200,
      });

      $('#tabela_produto_escolher tbody').on('click', 'tr', function () {
        var row = datatable.row(this);

        if (row.data()) {
          var selectedRows = datatable.rows('.selected');

          if (row.node().classList.contains('selected')) {
            row.node().classList.remove('selected');
          } else {
            selectedRows.nodes().to$().removeClass('selected');
            row.node().classList.add('selected');
          }
        }
      });

      $('#pesquisar_produto_escolher').on('input', function () {
        var valor_para_pesquisar = $(this).val();
        datatable.search(valor_para_pesquisar).draw();
      });

      if (produto_para_alterar != null) {
        let produto = produtos_escolhidos[produto_para_alterar];
        let produtoLen = produto.length;

        for (var i = 0; i < produtoLen; i++) {
          document.getElementsByClassName('input_produto')[i].value =
            produto[i];
        }
      }
    });
  }
  function gera_cabecalho_produto(cabecalho) {
    document.getElementById('meus_inputs_escolher_produto').innerHTML = '';
    var cabecalhoLen = cabecalho.length;

    for (var i = 0; i < cabecalhoLen; i++) {
      var item_do_cabecalho = `<th>` + cabecalho[i] + `</th>`;
      document.getElementById('cabecalho_produto_escolher').innerHTML =
        document.getElementById('cabecalho_produto_escolher').innerHTML +
        item_do_cabecalho;
    }

    for (var i = 0; i < cabecalhoLen; i++) {
      var meu_input =
        `<label>` +
        cabecalho[i] +
        `</label><input disabled class="input_produto" type="text" id="` +
        cabecalho[i] +
        `" />`;

      document.getElementById('meus_inputs_escolher_produto').innerHTML =
        document.getElementById('meus_inputs_escolher_produto').innerHTML +
        meu_input;
    }

    var meu_input =
      `<label>` +
      'qtd' +
      `</label><input class="input_produto" type="text" id="` +
      'qtd' +
      `" />`;

    document.getElementById('meus_inputs_escolher_produto').innerHTML =
      document.getElementById('meus_inputs_escolher_produto').innerHTML +
      meu_input;

    var meu_input =
      `<label>` +
      'Valor Total' +
      `</label><input disabled class="input_produto" type="text" id="` +
      'Valor Total' +
      `" />`;

    document.getElementById('meus_inputs_escolher_produto').innerHTML =
      document.getElementById('meus_inputs_escolher_produto').innerHTML +
      meu_input;

    document.getElementById('qtd').addEventListener('input', function (e) {
      const input = e.data;
      const input_type = e.inputType;

      if (
        input === 'NaN' ||
        !isNaN(parseFloat(input)) ||
        input_type == 'deleteContentBackward' ||
        input_type == 'deleteContentForward'
      ) {
        var preco = document.getElementById('Preço').value.replace(',', '.');
        var qtd = document.getElementById('qtd').value.replace(',', '.');
        document.getElementById('Valor Total').value = qtd * preco;
      }
    });

    so_aceita_num_e_virgula('qtd');
  }

  function ler_dados_clientes() {
    $.ajax({
      url: my_url() + 'ler_dados_clientes',
      type: 'POST',
    }).done(function (data) {
      let dados = data.retorno;
      let cabecalho = dados[0];
      gera_cabecalho_cliente(cabecalho);

      dados = dados.slice(1, dados.length);

      try {
        $('#tabela_cliente_escolher').DataTable().clear();
        $('#tabela_cliente_escolher').DataTable().destroy();
      } catch (e) {}

      const datatable = new DataTable('#tabela_cliente_escolher', {
        data: dados,
        deferRender: true,
        scrollCollapse: true,
        scroller: true,
        scrollY: 200,
      });

      $('#tabela_cliente_escolher tbody').on('click', 'tr', function () {
        var row = datatable.row(this);

        if (row.data()) {
          var selectedRows = datatable.rows('.selected');

          if (row.node().classList.contains('selected')) {
            row.node().classList.remove('selected');
          } else {
            selectedRows.nodes().to$().removeClass('selected');
            row.node().classList.add('selected');
          }
        }
      });

      $('#pesquisar_cliente_escolher').on('input', function () {
        var valor_para_pesquisar = $(this).val();
        datatable.search(valor_para_pesquisar).draw();
      });
    });
  }
  function gera_cabecalho_cliente(cabecalho) {
    document.getElementById('meus_inputs_escolher_cliente').innerHTML = '';
    var cabecalhoLen = cabecalho.length;

    for (var i = 0; i < cabecalhoLen; i++) {
      var item_do_cabecalho = `<th>` + cabecalho[i] + `</th>`;
      document.getElementById('cabecalho_cliente_escolher').innerHTML =
        document.getElementById('cabecalho_cliente_escolher').innerHTML +
        item_do_cabecalho;
    }

    for (var i = 0; i < cabecalhoLen; i++) {
      var meu_input =
        `<label>` +
        cabecalho[i] +
        `</label><input disabled class="input_cliente" type="text" id="` +
        cabecalho[i] +
        `" />`;

      document.getElementById('meus_inputs_escolher_cliente').innerHTML =
        document.getElementById('meus_inputs_escolher_cliente').innerHTML +
        meu_input;
    }
  }
</script>
