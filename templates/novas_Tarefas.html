<!DOCTYPE html>
<html lang="pt-br">

  {% include 'head.html' %}
<head>
  <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Bootstrap JS (Popper.js included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>

    /* Adicione estilos CSS aqui para tornar o layout responsivo */
    .custom-label {
      display: block;
      margin-bottom: 8px;
    }

    .row {
      margin-right: -15px;
      margin-left: -15px;
    }

    .mb-3 {
      margin-bottom: 20px;
    }

    h3 {
      font-size: 20px;
      margin-top: 8px;
    }

    /* Estilo para destacar campos alimentados pelo usuário */
    .input-destaque {
        border: 2px solid #4CAF50; /* Cor de destaque (verde) */
    }

  .elemento-oculto {
  display: none;
}

    /* Adicione estilos para o scroll em dispositivos móveis */
    @media (max-width: 767px) {

      body {
        overflow-x: hidden;
      }

      .scrollable-content {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(100vh - 180px); /* Ajuste de altura máxima para rolagem */
      }

      .table-wrapper {
        overflow-x: auto;
      }

      .btn {
        padding: 10px 14px;
        font-size: 14px;
      }

      .floating-buttons {
        position: fixed;
        top: 40px;
        right: 10px;
        width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .floating-buttons .btn {
        margin-bottom: 8px;
      }

      .header span {
        display: block; /* Para colocar o texto "NOTH CROMO" abaixo de "RECEBIMENTO" */
      }

      /* Estilo para destacar campos alimentados pelo usuário */
      .input-destaque {
          border: 2px solid #4CAF50; /* Cor de destaque (verde) */
    }
    }
  </style>
  <title>Novas Tarefas</title>
</head>
  <body>
    <div class="header">
      <img
        src="https://drive.google.com/uc?export=view&id=1-grKAm790rFePojbqFxCeNXy4rHzrV4j"
        alt="Logo da Empresa"
      />
      NOVAS TAREFAS - <span>NOTH CROMO</span>
    </div>

    <link
      rel="icon"
      href="https://drive.google.com/uc?export=view&id=SEU_ID_DA_IMAGEM"
      type="image/x-icon"
    />

    <div class="container">
      <div class="row mt-3 mb-3 scrollable-content">
        <div class="col-md-3">
          <label for="numeroControle" class="custom-label">Número de Controrole</label>
          <input
            id="numeroControle"
            type="text"
            class="form-control highlight-input"
            placeholder="Controle"
            list="numerosDeControle"
          />
        </div>

        <!-- Campo Data de Recebimento -->
        <div class="col-md-4 mb-3">
          <label for="dataLancamento" class="custom-label">Data de Lançamento</label>
          <input
              id="dataLancamento"
              type="date"
              class="form-control"
          />
      </div>

      <!-- Campo Data de Recebimento -->
      <div class="col-md-4 mb-3">
        <label for="client-name" class="custom-label">Nome do Cliente</label>
        <input
            id="client-name"
            type="text"
            class="form-control"
        />
    </div>
      </div>

      <!-- Seção de Quantidade, Código do Produto, Descrição do Produto e Operação -->
    <div class="row">
        <div class="col-md-2">
            <label for="quantidade" class="custom-label">Quantidade</label>
            <input
            id="quantidade"
            type="number"
            class="form-control"
            placeholder="Quantidade"
            value="1" 
            min="1" 
        />
        </div>

        <div class="col-md-3">
            <!-- Campo de entrada para o código do produto -->
            <label for="codigoProduto" class="custom-label">Código do Produto</label>
            <div class="input-group">
                <input
                    id="codigoProduto"
                    type="text"
                    class="form-control"
                    placeholder="Produto ou serviço"
                />
                <div class="input-group-append">
                    <button
                        id="btnPesquisarProduto"
                        class="btn btn-outline-secondary"
                        style="background-color: blue; border-color: blue;"
                        title="Pesquisar Produto"
                    >
                        <i class="material-icons" style="color: white;">search</i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <label for="descricaoProduto" class="custom-label">Desc Serviço/ Produto / Tarefa</label>
            <textarea
                id="descricaoProduto"
                class="form-control"
            ></textarea>
        </div>
        <div class="col-md-3">
            <label for="operacao" class="custom-label">Operação</label>
            <input
                id="operacao"
                type="text"
                class="form-control"
                placeholder="Operação"
            />
        </div>
    </div>

    <!-- Seção de Observações -->
    <div class="col-md-12 mb-3">
        <label for="queixaCliente" class="custom-label">Observação:</label>
        <textarea id="queixaCliente" class="form-control" rows="1" oninput="autoResize(this)"></textarea>
      </div>

<!-- Modal de Pesquisa de Produto -->
<div class="modal fade" id="modalPesquisaProduto" tabindex="-1" role="dialog" aria-labelledby="modalPesquisaProdutoLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalPesquisaProdutoLabel">Pesquisar Produto</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <label for="filtroProdutos" class="custom-label">Filtrar Produtos ou Serviço</label>
              <input id="filtroProdutosModal" type="text" class="form-control" placeholder="Digite o código ou nome para pesquisar">
              <label for="listaProdutosModal" style="margin-top: 10px;">Lista de Produtos ou Serviço</label>
              <select id="listaProdutosModal" class="form-control"></select>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
              <button type="button" class="btn btn-primary" id="btnSelecionarProdutoModal">Selecionar Produto</button>
          </div>
      </div>
  </div>
</div>


    <!-- Campos ocultos somente para parâmetros -->
    <input type="text" id="inputIDORDEM" placeholder="IDORDEM" style="display: none;" />
    <input type="text" id="inputIDPRODUTO" placeholder="IDPRODUTO" style="display: none;" />

    <input type="text" id="input1" style="display: none;" />
    <input type="text" id="input2" style="display: none;" />
    <input type="text" id="input3" style="display: none;" />

    <!-- Seção para mostrar o valor da operação (está escondida inicialmente) -->
    <div id="resultado" class="form-group" style="display: none;">
        <label for="valorOperacao" class="custom-label">Op</label>
    </div>
   

    <div class="row mt-2">
        <!-- Botão Adicionar -->
        <div class="col-md-4">
            <button
                id=" btnAdicionar"
                onclick="adicionarLinhaTabela()" 
                class="btn btn-block button-height"
                style="
                    background-color: #555;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    width: 100%;
                "
            >
                <span class="material-icons" style="margin-right: 8px">add</span>
                Adicionar
            </button>
        </div>

<!-- Tabela para exibir itens adicionados-->
    <!-- Botão Adicionar -->
    <div class="col-md-4">
        <button
            id="deleteRowsBtn"
            onclick="deleteSelectedRows()" 
            class="btn btn-block button-height"
            style="
                background-color:  #f44336;;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                display: flex;
                align-items: center;
                width: 100%;
            "
        >
            <span class="material-icons" style="margin-right: 8px">delete</span>
             Excluir Linhas
        </button>
    </div>
    
        <!-- Botão Salvar -->
        <div class="col-md-4">
            <button
                id="btnSave"
                class="btn btn-block button-height"
                style="
                    background-color: #4caf50;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    width: 100%;
                "
            >
                <span class="material-icons" style="margin-right: 8px">save</span>
                Salvar
            </button>
        </div>
    </div>
    
</div>


    <datalist id="numerosDeControle"></datalist>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Confirmação</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Você tem certeza que quer fechar a página?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="google.script.run.confirmClose()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela Tabular   onclick="generatePDFsForSelectedOperations()"  -->
    <div class="table-responsive myTable table-wrapper scrollable-content">
      <div id="table_checklist" class="tabulator myTable"></div>
    </div>

 
    <select id="dateFilterDropdown">
        <!-- As opções serão preenchidas pelo JavaScript -->
    </select>
          <!--Lista supresa no campo  -->
        <datalist id="numerosDeControle">
              <!-- As opções serão adicionadas aqui pelo JavaScript -->
        </datalist>



  </body>

  <script>

let dados_novos_produtos;

     // Varivavel para o ApiScript
 var minhaUrl =
        'https://script.google.com/macros/s/AKfycbzuSM5335S2Vfu2AEbQ-7D2kzGHzW3L0al2s4KmWmFNNWAD06t1vAejfB6jsuyuFdPy5g/exec'
    
   function autoResize(element) {
  element.style.height = 'auto';
  element.style.height = (element.scrollHeight) + 'px';

    // Converter para maiúsculas
    elemento.value = elemento.value.toUpperCase();

};

    
    function formatarParaFormatoInput(dataFormatada) {
    const partes = dataFormatada.split("/");
    return `${partes[2]}-${partes[1]}-${partes[0]}`;
}


function formatarData(data) {
    const partes = data.split('-');
    const dataFormatada = partes[2] + '/' + partes[1] + '/' + partes[0];
    return dataFormatada;
}

// Verifique se a variável NumControleValue já foi declarada
if (typeof numControleValue === 'undefined') {
     let numControleValue;
}

// Verifique se a variável OPERATIONS_ORDER já foi declarada
if (typeof OPERATIONS_ORDER === 'undefined') {
  // Declare e inicialize a variável
  const OPERATIONS_ORDER = [
    "DES",
    "COM",
    "CRO",
    "USI",
    "DEC",
    "FRE",
    "SOL",
    "BRU",
    "PER",
    "TES",
    "MON",
  ];
}

// Verifique se a variável today já foi declarada
if (typeof today === 'undefined') {
  // Declare e inicialize a variável
  const today = new Date();
  // Restante do código que utiliza a variável today
  const formattedToday = getFormattedDate("DD/MM/YYYY", today);
}


// Função para destruir a tabela e limpar variáveis
function limparTabela() {
  if (table_checklist) {
    table_checklist.destroy();
  }

  // Remova as variáveis se elas já foram declaradas
  if (window.hasOwnProperty('isCheckboxClicked')) {
    delete window.isCheckboxClicked;
  }
  if (window.hasOwnProperty('selectedIDs')) {
    delete window.selectedIDs;
  }
  if (window.hasOwnProperty('selectedRowsData')) {
    delete window.selectedRowsData;
  }
  if (window.hasOwnProperty('editedRows')) {
    delete window.editedRows;
  }
}

// Função para inicializar a tabela e variáveis
function inicializarTabela() {
  // Declare e inicialize as variáveis novamente
  window.isCheckboxClicked = false;
  window.selectedIDs = [];
  window.selectedRowsData = [];
  window.editedRows = new Set();
  today = new Date();
 formattedToday = formatDateToDDMMYYYY(today);
}

$(window).on('beforeunload', function() {
  limparTabela();
});

    var numeroControleElement = document.getElementById("numeroControle");
    if (numeroControleElement) {
      var numeroControle = numeroControleElement.value.trim().replace(/"/g, "");
      // Restante do seu código
    } else {
      console.error("Elemento 'numeroControle' não encontrado.");
    }

    var dateFilterDropdownElement = document.getElementById("dateFilterDropdown");
    if (dateFilterDropdownElement) {
      var dateFilterDropdown = dateFilterDropdownElement.value;
      // Restante do seu código
    } else {
      console.error("Elemento 'dateFilterDropdown' não encontrado.");
    }



    Object.defineProperty(window, "selectedIDs", {
      set: function (value) {
        console.trace("selectedIDs foi alterado: ", value);
        this._selectedIDs = value;
      },
      get: function () {
        return this._selectedIDs;
      },
      configurable: true,
    });

    function formatarData(data) {
      const [ano, mes, dia] = data.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function updateSelectedIDs() {
      console.trace("updateSelectedIDs foi chamada de:");

      selectedIDs = [];
      selectedRowsData = [];

      table_checklist.getRows("active").forEach((row) => {
        if (row.isSelected()) {
          const rowData = row.getData();

          selectedIDs.push(rowData.idPCP);

          selectedRowsData.push({
            id: rowData.idPCP,
            row: row,
          });
        }
      });

      selectedIDs = [...new Set(selectedIDs)];
      selectedRowsData = [...new Set(selectedRowsData)];

      console.log("IDs selecionados:", selectedIDs);
      console.log("Dados de linhas selecionadas:", selectedRowsData);
    }

     // Função para retornar a data atual no formato DD/MM/AAAA
    function getDataAtual() {
    const hoje = new Date();
    hoje.setDate(hoje.getDate() -30); // Subtrai 30 dias da data de hoje
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');

    // Formata a data para o formato DD/MM/AAAA
    const dataFormatada = `${dia}/${mes}/${ano}`;  
    // Retorna a data formatada
    return dataFormatada;
}

// Função para retornar a data atual no formato DD/MM/AAAA
function getDataFinal() {
    const hoje = new Date();
    hoje.setDate(hoje.getDate()); // Subtrai 30 dias da data de hoje
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');

    // Formata a data para o formato DD/MM/AAAA
    const dataFormatada_Final = `${dia}/${mes}/${ano}`;  

    document.getElementById('dataLancamento').value = formatarParaFormatoInput(dataFormatada_Final);

    // Retorna a data formatada
    return dataFormatada_Final;
}

    $(document).ready(function () {
      //initializeTable_Checklist_pedentes();
      //getDataAtual();
      getDataFinal();
      inicializarTabela();
      initializeTable();
      onPaginaCarregada();
      selecionar_produtos();
      setupEventListeners();
      
      console.log("Documento carregado e pronto!");

    // Formatar campo de telefone
    $('#telefone').keyup(function () {
    var val = this.value.replace(/\D/g, '');
    var newVal = '';
    while (val.length > 0) {
    newVal += (val.length > 2 ? ' ' : '') + val.substr(0, 2);
    val = val.substr(2);
    }
    this.value = newVal.trim();
    });

    // Adicionar estilo ao campo quando preenchido
    $('input').blur(function () {
    if ($(this).val()) {
    $(this).addClass('filled');
    } else {
    $(this).removeClass('filled');
    }
    });

    // Adicionar evento de clique para o botão "Adicionar"
    $("#btnAdicionar").on("click", function () {
        adicionarLinhaTabela();
    });

// Adicionar descrição e operação pela função para atualizar campos
$("#codigoProduto").on("input", function () {
    // Obtenha o valor digitado
    var codigoProduto = $(this).val();
    console.log('codigoProduto', codigoProduto);

    // Formate o número conforme necessário
    var numeroFormatado = formatarNumero(codigoProduto);

    // Atualize o valor do campo com o número formatado
    $(this).val(numeroFormatado);

    // Chame a função para atualizar campos
    atualizarCamposProduto(numeroFormatado);
});

var codigoProdutoAutomatico = $("#codigoProduto").val();
atualizarCamposProduto(codigoProdutoAutomatico);


 // Adicionar evento de clique para o botão de pesquisa
// Adicionar evento de clique para o botão de pesquisa
$("#btnPesquisarProduto").on("click", function () {
    console.log("Botão Pesquisar Produto clicado!");

    // Limpar o filtro ao abrir o modal
    $("#filtroProdutosModal").val("");

    // Carregar a lista de produtos no modal
    carregarListaProdutosFrontEnd();
    
    // Exibir o modal de pesquisa de produto
    $("#modalPesquisaProduto").modal("show");
});

// Adicionar evento de clique para o botão "Selecionar Produto" dentro do modal
$("#btnSelecionarProdutoModal").on("click", function () {
    // Obter o código do produto selecionado no modal
    var codigoProdutoSelecionado = $("#listaProdutosModal").val();

    // Atualizar os campos com os detalhes do produto selecionado
    atualizarCamposProduto(codigoProdutoSelecionado);

    // Fechar o modal
    $("#modalPesquisaProduto").modal("hide");
});



    // Adicionar evento de alteração para o campo de filtro
    $("#filtroProdutos").on("input", function () {
        // Obter o valor digitado
        var filtro = $(this).val();
        // Chamar a função para filtrar a lista de produtos no front-end
        filtrarListaProdutosFrontEnd(filtro);
    });

    // Adicionar evento de alteração para a lista de produtos
    $("#listaProdutos").on("change", function () {
         // Obter o código do produto selecionado
        var codigoProdutoSelecionado = $(this).val();

        // Atualizar os campos com os detalhes do produto selecionado
        atualizarCamposProduto(codigoProdutoSelecionado);

        // Ocultar a seção de Lista de Produtos
        $("#form").hide();
    });


            $(".scrollable-content").perfectScrollbar();
              
              });

    function autoResize(element) {
    element.style.height = 'auto';
    element.style.height = (element.scrollHeight) + 'px';

    // Converter para maiúsculas
    elemento.value = elemento.value.toUpperCase();

    };


// Função para formatar o número
function formatarNumero(numero) {
    // Remova caracteres não numéricos
    var numeroLimpo = numero.replace(/[^\d]/g, '');

    // Adicione um ponto a cada três dígitos do final para o início
    var numeroFormatado = numeroLimpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    return numeroFormatado;
}

// Função para adicionar uma nova linha à tabela
function adicionarLinhaTabela() {
    // Capturar os valores dos campos de entrada
    var numeroControle = $("#numeroControle").val();
    var dataLancamento = $("#dataLancamento").val();
    var nomeCliente = $("#client-name").val();
    var quantidade = $("#quantidade").val();
    var codigoProduto = $("#codigoProduto").val();
    var descricaoProduto = $("#descricaoProduto").val();
    var operacao = $("#operacao").val();
    var observacao = $("#queixaCliente").val();

    // Verificar se todos os campos obrigatórios estão preenchidos
    if (!numeroControle || !dataLancamento || !nomeCliente || !quantidade || !codigoProduto) {
        alert("Preencha todos os campos obrigatórios!");
        return;
    }

     // Adicionar uma nova linha à tabela
     var newRowData = {
        numControle: numeroControle,
        dataEntrada: dataLancamento,
        cliente: nomeCliente,
        qtd: quantidade,
        cod: codigoProduto,
        descricao: descricaoProduto,
        op: operacao,
        observacao: observacao
    };

    console.log('newRowData',newRowData)
    // Adicionar a nova linha à tabela
    table_checklist.addData([newRowData]);

    // Limpar os campos de entrada após adicionar a linha
    limparCamposEntrada();
}

// Função para limpar os campos de entrada após adicionar uma linha
function limparCamposEntrada() {
    $("#codigoProduto, #descricaoProduto, #operacao").val("");
}

// Função para atualizar campos com dados de produtos
function atualizarCamposProduto(codigoProduto) {
            // Encontre o produto pelo código na lista já carregada
            var produtoEncontrado = dados_novos_produtos.find(function (produto) {
                return produto.Cod_Produto === codigoProduto;
            });

            // Se o produto foi encontrado, atualize os campos
            if (produtoEncontrado) {
              //console.log('produtoEncontrado',)
                $("#descricaoProduto").val(produtoEncontrado.nome_produto);
                $("#operacao").val(produtoEncontrado.nome);
            } else {
                //console.log("Produto não encontrado.");
                $("#descricaoProduto").val("");
                $("#operacao").val("");
            }
        }

// Função para preencher a lista de produtos no front-end
function preencherListaProdutosFrontEnd() {
    // Limpar a lista de produtos
    $("#listaProdutos").empty();

    // Adicionar uma opção padrão
    $("#listaProdutos").append('<option value="">Selecione um produto</option>');

    // Adicionar cada produto à lista
    listaDeProdutos.forEach(function (produto) {
        $("#listaProdutos").append('<option value="' + produto.Cod_Produto + '">' + produto.Cod_Produto + ' - ' + produto.nome + ' - ' + produto.nome_produto + '</option>');
    });
}

// Função para filtrar a lista de produtos no front-end
function filtrarListaProdutosFrontEnd(filtro) {
    // Filtrar a lista de produtos
    var produtosFiltrados = listaDeProdutos.filter(function (produto) {
        // Inclua a lógica de filtro conforme necessário (por exemplo, por código ou nome)
        return produto.Cod_Produto.includes(filtro) || produto.nome.includes(filtro) || produto.nome_produto.includes(filtro);
    });

    // Preencher a lista de produtos filtrada
    preencherListaProdutosFrontEnd(produtosFiltrados);
}

// Atribuir a resposta da sua chamada AJAX à variável listaDeProdutos
function carregarListaProdutosFrontEnd(data) {
    // Atribuir a resposta a dados_novos_produtos globalmente
    dados_novos_produtos = data.novos_produtos;

    // Limpar a lista de produtos
    $("#listaProdutos").empty();

    // Adicionar uma opção padrão
    $("#listaProdutos").append('<option value="">Selecione um produto</option>');

    // Adicionar cada produto à lista
    dados_novos_produtos.forEach(function (produto) {
        $("#listaProdutos").append('<option value="' + produto.Cod_Produto + '">' + produto.Cod_Produto + ' - ' + produto.nome + ' - ' + produto.nome_produto + '</option>');
    });
}


function selecionar_produtos() {
console.log('Relatorio_Checklits_pedentes')
try {
    $.ajax({
        url: my_url() + "selecionar_novos_produtos",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
        }),
    })
    .done(function (data) {

      // Atribua a resposta a dados_novos_produtos globalmente
      dados_novos_produtos = data.novos_produtos;
      console.log("dados_novos_produtos:", dados_novos_produtos);

    // Chame a função para atualizar campos
    atualizarCamposProduto(codigoProduto);
    carregarListaProdutosFrontEnd(data)
      
    })
    .fail(function (xhr, status, error) {
        console.error("Erro ao buscar dados consolidados:", error);
        console.log("Status da requisição:", status);
        console.log("Resposta do servidor:", xhr.responseText);
    });
} catch (error) {
    console.error("Erro ao executar a função: " + error);
}
}
    



    function showAlert(message) {
      Swal.fire({
        title: "Atenção!",
        text: message,
        icon: "warning",
        confirmButtonColor: "#3085d6",
        confirmButtonText: "Entendi!",
      });
    }

    function customDataFormatter(cell, formatterParams, onRendered) {
      const value = cell.getValue();

      if (value === "31/12/1969") {
        return "";
      }
    }

    function getFormattedDate(format = "YYYY-MM-DD") {
  // Verifique se a variável já foi declarada antes de redeclarar
  if (typeof window.today === 'undefined') {
    window.today = new Date();
  }
    // Verifique se a variável já foi declarada antes de redeclarar
    if (typeof window.dd === 'undefined') {
    window.dd = String(today.getDate()).padStart(2, "0");
  }

      // Verifique se a variável já foi declarada antes de redeclarar
      if (typeof window.dd === 'undefined') {
    window.dd = String(today.getDate()).padStart(2, "0");
  }

      // Verifique se a variável já foi declarada antes de redeclarar
      if (typeof window.mm === 'undefined') {
    window.mm =  String(today.getMonth() + 1).padStart(2, "0");
  }
        // Verifique se a variável já foi declarada antes de redeclarar
        if (typeof window.yyyy === 'undefined') {
    window.yyyy =  today.getFullYear();
  }
      switch (format) {
        case "YYYY-MM-DD":
          return yyyy + "-" + mm + "-" + dd;
        case "DD/MM/YYYY":
          return dd + "/" + mm + "/" + yyyy;
        default:
          return yyyy + "-" + mm + "-" + dd;
      }
    }

    function setDataLancamento() {

      if (typeof window.dd === 'undefined') {
    window.dd = String(today.getDate()).padStart(2, "0");
  }
      // Verifique se a variável já foi declarada antes de redeclarar
      if (typeof window.mm === 'undefined') {
    window.mm =  String(today.getMonth() + 1).padStart(2, "0");
  }
        // Verifique se a variável já foi declarada antes de redeclarar
        if (typeof window.yyyy === 'undefined') {
    window.yyyy =  String(today.getMonth() + 1).padStart(2, "0");
  }

      today = yyyy + "-" + mm + "-" + dd;

      document.getElementById("dataLancamento").value = today;
    }

    function tabToNextRowEditor(cell, onRendered, success, cancel, editorParams) {

      if (typeof window.editor === 'undefined') {
    window.editor = document.createElement("input");
      editor.setAttribute("type", "text");

      editor.style.textAlign = "left";
  }

  if (typeof window.cellValue === 'undefined') {
    window.cellValue = cell.getValue();
  } 

      if (
        cellValue === undefined ||
        (typeof cellValue === "string" && cellValue.startsWith("undefined"))
      ) {
        editor.value = "";
        console.log("teste...", +cellValue);
      } else {
        editor.value = cellValue;
        console.log("teste...", +editor.value);
      }

      onRendered(function () {
        editor.focus();
        editor.setSelectionRange(editor.value.length, editor.value.length);
      });

      editor.addEventListener("keydown", function (e) {
        if (e.key === "Tab" || e.keyCode === 13) {
          e.preventDefault();

          success(editor.value);

          const currentField = cell.getColumn().getField();
          const nextRow = cell.getRow().getNextRow();

          if (nextRow) {
            console.log("Movendo para a próxima linha...");
            setTimeout(() => {
              nextRow.getCell(currentField).edit();
            }, 10);
          } else {
            console.log("Não existe próxima linha");
          }
        }
      });

      return editor;
    }

    function loadDataAndApplyFilter() {

      // Inicialize today antes de qualquer referência a ele
      if (typeof myData === 'undefined') {
         myData = fetchDataFromSomewhere();
      }

      table_checklist.setData(myData);

      // Inicialize today antes de qualquer referência a ele
      if (typeof formattedToday === 'undefined') {
         formattedToday = getFormattedDate("DD/MM/YYYY");
      }
      table_checklist.setFilter("dataEntrada", "!=", formattedToday);
    }

  function transformData(data) {
  console.log("Dados de entrada para transformação:", data);

  if (!data || !data.retorno_especifico) {
    console.error("Dados inválidos fornecidos para transformação:", data);
    return [];
  }

  let parsedData;

  try {
  // Verifica se os dados já são um array
  if (Array.isArray(data.retorno_especifico)) {
    parsedData = data.retorno_especifico;
  } else {
    console.error("Dados inválidos fornecidos para transformação:", data.retorno_especifico);
    return [];
  }
} catch (error) {
  console.error("Erro ao analisar os dados JSON:", error);
  return [];
}

  const transformed = parsedData.map((row) => {
    return {
      dataEntrada: row.DataRec_OrdemServiços ?? "", // Adicionado
      numControle: row.Recebimento ?? "",
      cliente: row.Nome_cliente ?? "",
      descricao: row.nome_produto ?? "",
      nota: row.NotaInterna ?? "",
      idPCP: row.ID_Checklist ?? "", // Mudei o nome da propriedade para corresponder ao nome na tabela
      referenciaProducao: row.Referencia_Produto ?? "",
      qtd: row.Qtd_Produto ?? "", // Adicionado
      op: row.ID_Ordem ?? "", // Adicionado
      cod: row.Cod_Produto ?? "",
      observacao: row.QUEIXA_CLIENTE ?? "",
      linkPDF: row.LINK_PDF_CHECKLIST ?? "", // Adicionado
      nomeCliente: row.nome ?? "", // Adicionado
      idOrdem: row.ID_Ordem ?? "", // Adicionado
      idRecebimento: row.ID_Recebimento ?? "", // Adicionado
      idCliente: row.ID_cliente ?? "", // Adicionado
      idGrupo: row.idGrupo ?? "", // Adicionado
      idOperacaoServico: row.idoperacaoServico ?? "", // Adicionado
      statusChecklist: row.Status_Checklist ?? "", // Adicionado
      usuarioCadastro: row.Usuario_Cadastro ?? "", // Adicionado
      idComponente: row.ID_Componente ?? "", // Adicionado
      idPostoTrabalho: row.ID_PostoTrabalho ?? "", // Adicionado
      dataChecklistOrdemServicos: row.DataChecklist_OrdemServiços ?? "", // Adicionado
    };
  });

  console.log("Dados transformados:", transformed);
  return transformed;
}

  // Vamos adicionar uma função para inicializar a tabela
  function initializeTable() {

  function highlightEditable(cell, formatterParams, onRendered) {
    console.log("A função highlightEditable foi chamada");

    const element = cell.getElement();

    // Se a célula for editável, adicione a classe
    if (cell.getColumn().getDefinition().editor) {
      element.classList.add("editable-cell");
    }
    return cell.getValue();
  }

  function onRowSelected(row) {

    let rowData = row.getData();
    if (!selectedIDs.includes(rowData.idPCP)) {
      selectedIDs.push(rowData.idPCP);
    }
    console.log("IDs selecionados:", selectedIDs);
    console.log("Número da linha:", row.getPosition(true)); // Número da linha
    console.log("ID selecionado:", rowData.idNovasTarefas);
  }

  function onRowDeselected(row) {
    let rowData = row.getData();
    const index = selectedIDs.indexOf(rowData.idPCP);
    if (index !== -1) {
      selectedIDs.splice(index, 1);
    }
    console.log("IDs selecionados após desmarcar:", selectedIDs);
    console.log("Número da linha:", row.getPosition(true)); // Número da linha
    console.log("ID desmarcado:", rowData.idNovasTarefas);
  }

    // Adicione a parte fornecida no início da tabela
    table_checklist = new Tabulator("#table_checklist", {
      pagination:"local",
      paginationSize:300,
      paginationInitialPage: 1,
      movableColumns:true,
      paginationButtonNext: "<i class='fas fa-chevron-right'></i>", // Ícone para próximo
      paginationButtonPrev: "<i class='fas fa-chevron-left'></i>", // Ícone para anterior
      name: "table_checklist",
      data: [],
      deferRender: true,
      scrollCollapse: true,
      scroller: true,
      scrollY: 200,
      // Classificação inicial
      initialSort: [
        { column: "dtProducao", dir: "asc" },
        { column: "SEQ", dir: "asc" },
        { column: "op", dir: "asc" },
      ],

      columns: [
        // Colunas da sua tabela
        {
          title: "Nº Controle",
          field: "idOrdem",
          hozAlign: "center",
        },
        {
          title: "Cliente",
          field: "cliente",
          hozAlign: "left",
        },
        {
          title: "Cód",
          field: "cod",
          hozAlign: "center",
        },
        {
          title: "Qtda",
          field: "qtd",
          hozAlign: "center",
        },
        {
          title: "Desc Serviço/ Produto / Tarefa",
          field: "descricao",
          hozAlign: "left",
          editor: tabToNextRowEditor,
          formatter: highlightEditable,
        },
        {
          title: "Nota",
          field: "nota",
          hozAlign: "center",
        },
        {
          title: "Referência Produto",
          field: "referenciaProducao",
          hozAlign: "center",
        },
        {
          title: "Op",
          field: "op",
          hozAlign: "center",
          visible: false,
        },
        {
          title: "Observação",
          field: "observacao",
          hozAlign: "left",
          editor: tabToNextRowEditor,
          formatter: highlightEditable,
        },
        {
          title: "Id PCP",
          field: "idPCP",
          hozAlign: "center",
          visible: false,
        },
        {
          title: "",
          field: "select",
          cssClass: "white-bg",
          hozAlign: "center",
          headerSort: false,
          headerClick: function (e, column) {
            try {
              const headerCheckbox = column
                .getElement()
                .querySelector("#selectAllCheckbox");
              if (headerCheckbox) {
                // Obtenha todas as linhas ativas
                const activeRows = table_checklist.getRows("active");
                selectedIDs = []; // Limpe o array de IDs selecionados

                if (headerCheckbox.checked) {
                  // Desmarcar todas as linhas ativas
                  activeRows.forEach((row) => row.deselect());
                  headerCheckbox.checked = false;
                } else {
                  // Seleccionar todas as linhas ativas e adicionar seus IDs ao array selectedIDs
                  activeRows.forEach((row) => {
                    const rowData = row.getData();
                    selectedIDs.push(rowData.idPCP);
                    row.select();
                  });
                  headerCheckbox.checked = true;
                }
                updateSelectedIDs(); // Atualize selectedIDs após mudança
                console.log(
                  "IDs selecionados via cabeçalho:",
                  selectedIDs
                );
              }
            } catch (error) {
              console.error("Erro em headerClick:", error);
            }
          },
          titleFormatter: function () {
            const labelElement = document.createElement("label");
            labelElement.className = "checkbox-material";

            const checkboxElement = document.createElement("input");
            checkboxElement.type = "checkbox";
            checkboxElement.id = "selectAllCheckbox";

            checkboxElement.addEventListener("change", function (e) {
              if (this.checked) {
                table_checklist.getRows("active").forEach((row) => row.select());
              } else {
                table_checklist.getRows("active").forEach((row) => row.deselect());
              }

              document.querySelectorAll(".row-checkbox").forEach((cb) => {
                cb.checked = this.checked;
              });

              // Atualiza o array selectedIDs
              updateSelectedIDs();

              e.stopPropagation();
            });

            const spanElement = document.createElement("span");
            spanElement.className = "checkmark";

            labelElement.appendChild(checkboxElement);
            labelElement.appendChild(spanElement);

            return labelElement;
          },

          formatter: function (cell, formatterParams, onRendered) {
            const labelElement = document.createElement("label");
            labelElement.className = "checkbox-material";

            const checkboxElement = document.createElement("input");
            checkboxElement.type = "checkbox";
            checkboxElement.className = "row-checkbox";

            checkboxElement.addEventListener("change", function () {
              const rowData = cell.getRow().getData();
              const id = rowData.idPCP;

              if (this.checked) {
                cell.getRow().select();
              } else {
                cell.getRow().deselect();
              }

              // Atualiza o array selectedIDs
              updateSelectedIDs();
            });

            const spanElement = document.createElement("span");
            spanElement.className = "checkmark";

            labelElement.appendChild(checkboxElement);
            labelElement.appendChild(spanElement);

            return labelElement;
          },
        },
      ],

      rowSelected: onRowSelected, // Adicionando a função de linha selecionada
      rowDeselected: onRowDeselected, // Adicionando a função de linha desmarcada

      rowFormatter: function (row) {
        const data = row.getData();
        if (data.dataEntrada !== "-") {
          row.getElement().classList.add("highlighted-row"); // Aplica o destaque na linha
          row.getCells().forEach((cell) => {
            if (cell.getColumn().getField() !== "select") {
              cell.getElement().style.backgroundColor = "white";
              cell.getElement().style.color = "Black";
            }
          });
        }
      },
      cellEdited: function (cell) {
        const value = cell.getValue();
        const oldValue = cell.getOldValue();

        // Se o novo valor está vazio, o valor antigo não estava vazio, ou o novo valor é "undefined", restaure o valor antigo
        if (
          (value.trim() === "" && oldValue.trim() !== "") ||
          value === "undefined"
        ) {
          cell.restoreOldValue();
        }

        cell.getElement().style.color = "red";
      },

      dataChanged: function (data) {
        // Atualiza as contagens no rodapé
        //updateFooterCounts();
      },

      selectable: "highlight",
    });

    // Aplicar o filtro imediatamente após a inicialização da tabela

    // Inicialize today antes de qualquer referência a ele
    if (typeof formattedToday === 'undefined') {
      formattedToday = getFormattedDate("DD/MM/YYYY");
    }
    table_checklist.setFilter("dataEntrada", "!=", formattedToday);

    // Agora, defina a função renderTable
    window.renderTable = function (data) {
      // Atualiza os dados na tabela Tabulator
      table_checklist.setData(data);
    };
    setupEventListeners();
  }
function handleTabPress(event) {
  if (event.keyCode === 13) {
    // Se a tecla pressionada for 'tab'
    event.preventDefault(); // Prevenir o comportamento padrão

    // Obtenha a célula atual que está sendo editada
    const currentCell = event.target._cell;

    // Obtenha a próxima linha
    const nextRow = currentCell.getRow().getNextRow();

    if (nextRow) {
      // Se existir uma próxima linha, defina a célula da mesma coluna nessa linha para ser editada
      nextRow.getCell(currentCell.getColumn().getField()).edit();
    }
  }
}



function openDialog() {
  // Atualizar a lista de IDs selecionados antes de fazer qualquer coisa
  updateSelectedIDs();

  // Exibe os IDs coletados no console
  console.log("IDs selecionadosTONY:", selectedIDs);

  if (selectedIDs.length > 0) {
    var dialog = document.querySelector("#myDialog");
    if (!dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    dialog.showModal();
    // preencherModalComDadosDaPagina();  // Copia os dados para o modal
  } else {
    Swal.fire({
      title: "Atenção!",
      html: "Por favor, selecione pelo menos uma linha para editar. <strong style='font-size: 20px;'>✅</strong>",
      icon: "warning",
      confirmButtonColor: "#28a745", // Verde
      confirmButtonText: "Entendi!",
    });
  }
}

// SELEÇÃO DO MODAL (sem alterações)
function getSelectedSEQ() {
  var radios = document.getElementsByName("SEQOption");

  for (var i = 0; i < radios.length; i++) {
    if (radios[i].checked) {
      return radios[i].value;
    }
  }

  return null; // Se nenhum valor for selecionado
}

function saveEditedSEQ() {
  var newSEQ = document.getElementById("newSEQ").value;

  // Chamada ao GAS para atualizar os valores na folha
  updateSheetAJAX(selectedIDs, newSEQ);

  // Limpe a caixa de input
  document.getElementById("newSEQ").value = "";
  closeEditModal();
}

function sendToServer(ids, option) {
  try {
    console.log("Enviando dados:", ids, option);

    $.ajax({
      type: "POST",
      data: {
        qualFuncao: "updateSheet",
        selectedIDs: JSON.stringify(ids),
        selectedOption: option,
      },
      url: minhaUrl, // Certifique-se de definir esta variável corretamente
    })
      .done(function (response) {
        try {
          var data = JSON.parse(response);
          if (data.success) {
            onPaginaCarregada(); // Atualizar a página
            console.log("Atualização bem-sucedida.");
            Swal.fire({
              title: "Sucesso!",
              text: data.message,
              icon: "success",
              confirmButtonColor: "#28a745", // Verde
              confirmButtonText: "Entendi!",
            });
          } else {
            console.error("Erro ao atualizar a folha:", data.message);
            Swal.fire({
              title: "Erro!",
              text: data.message,
              icon: "error",
              confirmButtonColor: "#d33",
              confirmButtonText: "Entendi!",
            });
          }
        } catch (internalError) {
          console.error(
            "Erro ao processar a resposta do servidor:",
            internalError
          );
          Swal.fire({
            title: "Erro!",
            text: "Houve um erro na resposta do servidor.",
            icon: "error",
            confirmButtonColor: "#d33",
            confirmButtonText: "Entendi!",
          });
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        console.error("Erro na chamada AJAX:", textStatus, errorThrown);
        Swal.fire({
          title: "Erro!",
          text: "Erro na chamada AJAX.",
          icon: "error",
          confirmButtonColor: "#d33",
          confirmButtonText: "Entendi!",
        });
      });
  } catch (error) {
    console.error("Erro ao enviar dados para o servidor:", error);
  }
}

function updateSheetAJAX(selectedIDs, newSEQ) {
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "updateSheet",
      selectedIDs: selectedIDs,
      newSEQ: newSEQ,
    },
    url: minhaUrl, // Certifique-se de que 'minhaUrl' é a URL do seu web app do GAS
  })
    .done(function (response) {
      try {
        var data = JSON.parse(response);
        console.log(data);
        onUpdateSuccess(data); // Você pode tratar a resposta como desejar
      } catch (e) {
        console.error("Erro ao analisar os dados:", e);
      }
    })
    .fail(function (error) {
      console.error("Erro ao atualizar a planilha:", error);
      onUpdateFailure(error); // Se você tiver uma função de tratamento de erro
    });
}

// Fechando o modal
function closeEditModal() {
  var modal = document.getElementById("myDialog");
  modal.close(); // Fecha o modal estilo MDL
}

// FILTRA A TABELA
function filterTable() {
  var filter = document.getElementById("filterInput").value;

  table_checklist.setFilter([
    [
      { field: "dataEntrada", type: "like", value: filter },
      { field: "pedido", type: "like", value: filter },
      // Adicione todos os outros campos que você deseja filtrar
      // ...
      { field: "orc", type: "like", value: filter },
    ],
  ]);
}

function getSelectedRowsDataPDF() {
  // Pegar todas as linhas selecionadas
  const allSelectedRows = tabletable_checklist.getSelectedRows();

  // Pegar índices das linhas atualmente visíveis
  const activeRowIndexes = table_checklist
    .getRows("active")
    .map((row) => row.getIndex());

  // Filtrar as linhas selecionadas que também estão visíveis
  const visibleSelectedRows = allSelectedRows.filter((row) =>
    activeRowIndexes.includes(row.getIndex())
  );

  // Mapear as linhas filtradas para seus dados
  return visibleSelectedRows.map((row) => {
    const rowData = row.getData();
    return {
      // ... (o resto do mapeamento que você já fez para cada campo)
    };
  });
}

function getSelectedRowsData() {
  // Atualiza a lista de IDs selecionados
  updateSelectedIDs();

  console.log("generatePDFsForSelectedOperations:", selectedIDs);

  const allSelectedRows = table_checklist.getSelectedRows();
  const activeRowIndexes = table_checklist
    .getRows("active")
    .map((row) => row.getIndex());
  const visibleSelectedRows = allSelectedRows.filter((row) =>
    activeRowIndexes.includes(row.getIndex())
  );

  return visibleSelectedRows.map((row) => {
    const rowData = row.getData();
    return {
      dataEntrada:
        rowData.dataEntrada !== undefined &&
        rowData.dataEntrada !== "31/12/1969" &&
        rowData.dataEntrada !== "-"
          ? rowData.dataEntrada
          : "",
      Orç:
        rowData.Orç !== undefined && rowData.Orç !== "-"
          ? rowData.Orç
          : "",
      pedido:
        rowData.pedido !== undefined && rowData.pedido !== "-"
          ? rowData.pedido
          : "",
      numControle:
        rowData.numControle !== undefined && rowData.numControle !== "-"
          ? rowData.numControle
          : "",
      SEQ:
        rowData.SEQ !== undefined && rowData.SEQ !== "-"
          ? rowData.SEQ
          : "",
      cliente:
        rowData.cliente !== undefined && rowData.cliente !== "-"
          ? rowData.cliente
          : "",
      cod:
        rowData.cod !== undefined && rowData.cod !== "-"
          ? rowData.cod
          : "",
      qtd:
        rowData.qtd !== undefined && rowData.qtd !== "-"
          ? rowData.qtd
          : "",
      op:
        rowData.op !== undefined && rowData.op !== "-" ? rowData.op : "",
      descricao:
        rowData.descricao !== undefined && rowData.descricao !== "-"
          ? rowData.descricao
          : "",
      observacao:
        rowData.observacao !== undefined && rowData.observacao !== "-"
          ? rowData.observacao
          : "",
      nota:
        rowData.nota !== undefined && rowData.nota !== "-"
          ? rowData.nota
          : "",
      dtProducao:
        rowData.dtProducao !== undefined && rowData.dtProducao !== "-"
          ? rowData.dtProducao
          : "",
      prazoEntrega:
        rowData.prazoEntrega !== undefined && rowData.prazoEntrega !== "-"
          ? rowData.prazoEntrega
          : "",
      idNovasTarefas:
        rowData.idNovasTarefas !== undefined &&
        rowData.idNovasTarefas !== "-"
          ? rowData.idNovasTarefas
          : "",
      idPCP:
        rowData.idPCP !== undefined && rowData.idPCP !== "-"
          ? rowData.idPCP
          : "",
    };
  });
}

function filterUniqueByIdChecklist(data) {
  const uniqueMap = new Map();
  data.forEach((entry) => uniqueMap.set(entry.idchecklist, entry));
  return Array.from(uniqueMap.values());
}

function getSelectedDataFromIDs(allData, selectedIDs) {
  if (!selectedIDs) {
    console.error("selectedIDs is undefined or null!");
    return [];
  }
  const idsSet = new Set(selectedIDs); // Para uma pesquisa mais eficiente
  return allData.filter((item) => idsSet.has(item.idPCP));
}

function showOperationsSummary(selectedData, callback) {
  const groupedByOperation = selectedData.reduce((acc, row) => {
    (acc[row.op] = acc[row.op] || []).push(row);
    return acc;
  }, {});

  let summaryMessage = "<strong>Resumo:</strong><br><br>";
  for (let op in groupedByOperation) {
    const rowsWithEmptySEQ = groupedByOperation[op].filter(
      (row) => !row.SEQ
    );
    summaryMessage += `
            <strong>Operação:</strong> ${op}<br>
            Total de registros: ${groupedByOperation[op].length}<br>
            Registros sem SEQ: ${rowsWithEmptySEQ.length}<br><br>
        `;
  }

  Swal.fire({
    title: "Resumo das Operações",
    html: summaryMessage,
    icon: "info",
    confirmButtonColor: "#3085d6",
    confirmButtonText: "Entendi!",
  }).then(() => confirmIncludingEmptySEQ(selectedData, callback));
}

function confirmIncludingEmptySEQ(selectedData, callback) {
  const rowsWithEmptySEQ = selectedData.filter((row) => !row.SEQ);

  if (!rowsWithEmptySEQ.length) {
    callback(selectedData);
    return;
  }

  Swal.fire({
    title: "Incluir linhas sem SEQ?",
    text: "Você deseja imprimir todas as linhas, incluindo aquelas com SEQ vazia?",
    icon: "question",
    showCancelButton: true,
    confirmButtonColor: "#3085d6",
    cancelButtonColor: "#d33",
    confirmButtonText: "Sim, incluir tudo",
    cancelButtonText: "Não, somente com SEQ",
  }).then((result) => {
    callback(
      result.isConfirmed
        ? selectedData
        : selectedData.filter((row) => row.SEQ)
    );
  });
}


var links = []; 

function generatePDFsForSelectedOperations() {
        const selectedData = getSelectedRowsData();
        if (!selectedData.length) {
          showWarning(
            "Por favor, selecione pelo menos uma linha para gerar o PDF."
          );
          return;
        }

        showOperationsSummary(selectedData, function (finalData) {
          showLoadingAlert(
            "Por favor, aguarde. Estamos processando sua solicitação..."
          );
          console.log("Dados enviados para o GAS:", finalData); // Log de dados enviados

          selectedItems = JSON.stringify(finalData);
          // Supondo que finalData seja uma variável que contém os dados
          const dadosEnviados = finalData.map(item => ({ "idPCP": item.idPCP }));
          $.ajax({
          url: my_url() + "impressao_checklists_especificos_Recebimento",
          type: "POST",
          contentType: "application/json",
                    data: JSON.stringify({
                      "dadosEnviados": dadosEnviados 
                    }),
                })
            .done(function (data) {
              console.log("Tipo da Resposta:", typeof data);
              console.log('data.resultados', data.resultados);
              if (data.success === true && data.resultados.length > 0) {
                 processarLinksNoApScript();
                } else {
                      // Ocultar o alerta de carregamento
                      hideLoadingAlert();
                      console.error("Nenhum link retornado pelo servidor.");
                      exibirMensagemErro("Não foi possível processar os links, Favor tente apertar novamente Impr.");
                    }
                  })
            .fail(errorHandler)
        });
      }


function processarLinksNoApScript() {
try {
  showLoadingAlert2(
    "Por favor, aguarde. Mais alguns Minutos. Finalizando a preparação dos PDFs..."
    );
    
  console.log('NORTH CROMO - processarLinksNoApScript');

  // Adicione um console log aqui para garantir que o código está sendo executado
  console.log('Antes da chamada AJAX');

  $.ajax({
    type: 'POST',
    data: {
      qualFuncao: 'processarLinks',
    },
    url: minhaUrl,
  })
  .done(function(response) {
      try {
        responseHandler(response);
      } catch (error) {
        console.error('Erro ao processar resposta:', error);
        // Trate o erro de processamento da resposta aqui, se necessário
      }
    })
    .fail(function(xhr, status, error) {
      console.error('Erro na solicitação AJAX:', status, error);
      errorHandler(xhr, status, error);
    })
    .always(hideLoadingAlert);
  } catch (error) {
    console.error('Erro ao executar o bloco try:', error);
    // Aqui você pode adicionar uma mensagem de alerta ou realizar outras ações conforme necessário
  }
}

function handleSuccess(data) {
  try {
    console.log('Resposta completa do ApScript:', data);

    let parsedData = JSON.parse(data);

    console.log('Tipo de parsedData:', typeof parsedData);
    console.log('parsedData.success:', parsedData.success);

    if (parsedData && parsedData.success && Array.isArray(parsedData.pdfLinks) && parsedData.pdfLinks.length) {
      parsedData.pdfLinks.forEach((linkInfo, i) => {
        console.log(`Link ${i + 1} - Nome do Documento: ${linkInfo.nomeDocumento}, Link PDF: ${linkInfo.linkPDF}`);
      });

      // Atualizar a variável global 'links' com os novos links
      links = parsedData.pdfLinks;

      // Chama a função responseHandler(data)
      responseHandler(data);

      // Agora você pode usar a variável 'links' conforme necessário
    } else {
      console.error('Erro no ApScript: handleSuccess - Resposta do ApScript não contém pdfLinks ou está vazia.');
      handleError('Erro ao processar os PDFs no ApScript.');
    }
  } catch (error) {
    console.error('Erro ao analisar JSON:', error);
    handleError('Erro ao processar a resposta do ApScript.');
  }
}

function responseHandler(data) {
  try {
    // Adicione um console log para ver a resposta completa
    console.log('Resposta completa do ApScript: responseHandler', data);

    var parsedData;

    // Verifica se data é uma string antes de fazer o parsing
    if (typeof data === 'string') {
      // Verifica se a string é válida antes de fazer o parsing
      if (/^\s*{/.test(data)) {
        parsedData = JSON.parse(data);
      } else {
        console.error('Erro: String JSON inválida.');
        handleError('Erro: String JSON inválida.');
        return;
      }
    } else {
      parsedData = data;
    }

    console.log('NORTH CROMO - Resposta do ApScript:', parsedData);

    if (parsedData.success) {
      // Se pdfLinks for uma string (um link direto), cria um array de objeto
      const linksArray = typeof parsedData.pdfLinks === 'string' ? [{ nomeDocumento: 'Documento', linkPDF: parsedData.pdfLinks }] : parsedData.pdfLinks;

      linksArray.forEach((linkInfo, i) => {
        console.log(`Link ${i + 1} - Nome do Documento: ${linkInfo.nomeDocumento}, Link PDF: ${linkInfo.linkPDF}`);
      });

      const linkGeradoPDF = parsedData.pdfLink;
      console.log("Link gerado do PDF:", linkGeradoPDF);

      // Chame a função de sucesso para gerar os PDFs
      onSuccessGeneratePDFs(data);

      // Notifique o usuário sobre a conclusão
      notifyCompletion();
    } else {
      console.error("Erro: Resposta inesperada do servidor.");
      handleError("Erro: Resposta inesperada do servidor.");
    }
  } catch (error) {
    console.error('Erro ao analisar JSON:', error);
    handleError('Erro ao processar a resposta do ApScript.');
  }
}

function showSuccessAlert(message) {
  Swal.fire({
    title: "Sucesso!",
    text: message,
    icon: "success",
    confirmButtonColor: "#3085d6",
    confirmButtonText: "Entendi!",
  });
}

function errorHandler(jqXHR, textStatus, errorThrown) {
  handleError("Erro ao gerar os PDFs.");
  console.error("Erro na chamada AJAX:", textStatus, errorThrown);
  console.log(jqXHR.responseText);
}

function showWarning(message) {
  Swal.fire({
    title: "Atenção!",
    html: `Por favor, selecione pelo menos uma linha para gerar o PDF. <strong style='font-size: 20px;'>✅</strong>`,
    icon: "warning",
    confirmButtonColor: "#3085d6",
    confirmButtonText: "Entendi!",
  });
}

function handleError(message) {
  Swal.fire({
    title: "Erro!",
    text: message,
    icon: "error",
    confirmButtonColor: "#3085d6",
    confirmButtonText: "Entendi!",
  });
}

// ALETAR DE ESPERAR
function showLoadingAlert(message) {
  Swal.fire({
    title: message,
    html: '<div class="spinner-border text-primary" role="status"><span class="sr-only">Carregando...</span></div>',
    showConfirmButton: false,
    allowOutsideClick: false,
  });
}

function showLoadingAlert2(message) {
  Swal.fire({
    title: message,
    html: '<div class="spinner-border text-primary" role="status"><span class="sr-only">Carregando...</span></div>',
    showConfirmButton: false,
    allowOutsideClick: false,
  });
}

function hideLoadingAlert() {
  Swal.close();
}

  function notifyCompletion() {
    Swal.fire({
      title: "Concluído!",
      text: "O PDF referente ao andamento da produção está pronto para impressão.",
      icon: "success",
      confirmButtonColor: "#3085d6",
      confirmButtonText: "Entendi!",
    });
  }


// PDF POR OPERAÇÃO VARIOS
function gerarPDF(data, operacao) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Aqui, adicione o código para inserir os dados no PDF...
  // Por exemplo:
  doc.text("Dados para a operação: " + operacao, 10, 10);

  // Adicione mais detalhes conforme necessário

  return doc.output("blob");
}

function onSuccessGeneratePDFs(data) {
  console.log("Resposta recebida:", data);
  console.log("Tipo da resposta:", typeof data);

  try {
    const parsedData = typeof data === 'object' ? data : JSON.parse(data);

    console.log('Parsed Data:', parsedData);

    if (!parsedData.success || !parsedData.pdfLinks || !Array.isArray(parsedData.pdfLinks) || parsedData.pdfLinks.length === 0) {
      console.error("Erro: NORTH CROMO - Resposta inesperada do servidor.");
      handleError("Erro: Resposta inesperada do servidor.");
      return;
    }

    showSuccessAlert("Os PDFs foram gerados com sucesso!");
    notifyCompletion();

    const linksContainer = document.getElementById("linksContainer");

    if (!linksContainer) {
      console.error("Elemento 'linksContainer' não encontrado!");
      return;
    }

    // Limpar os links antigos antes de adicionar novos
    linksContainer.innerHTML = "";

    parsedData.pdfLinks.forEach((linkData, index) => {
      // Se for uma string, assumimos que é um URL diretamente
      const link = typeof linkData === 'string' ? linkData : linkData.linkPDF;
      const header = parsedData.pdfHeaders[index] || `PDF ${index + 1}`;

      // Remover a parte específica do nome do cabeçalho
      const cleanedHeader = header.replace("NothCromo_", "");

      const linkElem = document.createElement("a");
      linkElem.href = link;
      linkElem.target = "_blank";

      // Adicionar ícone de PDF
      const pdfIcon = document.createElement("i");
      pdfIcon.className = "fas fa-file-pdf mr-2";
      
      linkElem.appendChild(pdfIcon);

      linkElem.innerHTML = `<i class="fas fa-file-pdf"></i>${cleanedHeader}`;
      linkElem.className = "pdfLink d-block mb-2";

      linksContainer.appendChild(linkElem);
    });

  } catch (error) {
    console.error('Erro ao analisar JSON:', error);
    handleError('Erro ao processar a resposta do ApScript.');
  }
}

// PDF POR OPERAÇÃO VARIOS
function imprimirPDF(pdfLinksFromServer, pdfHeaders) {
  const linksContainer = document.getElementById("pdfLinksContainer");

  if (!linksContainer) {
    console.error("Erro: O elemento #pdfLinksContainer não foi encontrado!");
    return;
  }

  linksContainer.innerHTML = "";

  let rowDiv;

  pdfLinksFromServer.forEach((pdfLink, index) => {
    if (index % 3 === 0) {
      rowDiv = document.createElement("div");
      rowDiv.className = "pdf-row";
      linksContainer.appendChild(rowDiv);
    }

    const link = document.createElement("a");
    link.href = pdfLink;
    link.target = "_blank";

    // Adicionar ícone de PDF
    const pdfIcon = document.createElement("i");
    pdfIcon.className = "fas fa-file-pdf";

    link.appendChild(pdfIcon);

    const header = pdfHeaders[index] || `PDF #${index + 1}`;
    const cleanedHeader = header.replace("NothCromo_", "");

    link.innerHTML += ` Download ${cleanedHeader}`;
    link.className = "pdf-link";

    rowDiv.appendChild(link);
  });

  const pdfLinks = document.querySelectorAll(".pdf-link");

  pdfLinks.forEach((link) => {
    link.addEventListener("click", function () {
      this.style.display = "none";
      let allHidden = true;
      pdfLinks.forEach((checkLink) => {
        if (checkLink.style.display !== "none") {
          allHidden = false;
        }
      });

      if (allHidden) {
        setTimeout(function () {
          window.location.reload();
        }, 5000);
      }
    });
  });
}

function notifyCompletion() {
  Swal.fire({
    title: "Concluído!",
    text: "O PDF referente ao Checklist está pronto para impressão.",
    icon: "success",
    confirmButtonColor: "#3085d6",
    confirmButtonText: "Entendi!",
  });
}

function callGeneratePDFsForOperations2(finalData) {
const idPCPData = selectedItems.map(item => item.idPCP);
console.log("Dados enviados para a segunda chamada:", finalData);
$.ajax({
  url: my_url() + "impressao_checklists_especificos_Recebimento",
  type: "POST",
  contentType: "application/json",
            data: JSON.stringify({
                  "item.idPCP": item.idPCP,
            }),
        })
.done(function(response) {
  // Você pode tratar a resposta da segunda chamada aqui, se necessário
  console.log("Resposta da segunda chamada:", response);
})
.fail(function() {
  console.error("Erro ao fazer a segunda chamada para generatePDFsForOperations2");
});
}

// -------------------
// Funções de AJAX
// -------------------

// CAPTURA OS DADOS DOS INPUTS
function coletarDadosDaInterface() {
     numeroControle = document.getElementById(
    "numeroControle"
    ).value;
    
     all_data = {
      numeroControle: numeroControle,
    };
    console.log(all_data)
    $.ajax({
      url: my_url() + "consultar_numero_controle_Checklist",
      data: JSON.stringify(all_data),
      contentType: 'application/json',
      type: 'POST',
    }).done(function (data) {
  try {
      let dados = data.retorno;
      console.log("Dados recebidos do servidor:", dados);
      updateTableData(data);
  } catch (e) {
      console.error("Erro ao analisar os dados:", e);
  }
})
.fail(function (jqXHR, textStatus, errorThrown) {
   console.error("Erro na solicitação AJAX: " + errorThrown);
   console.error("Status da solicitação: " + textStatus);
   mostrarErro();
});
}


// Função que será chamada quando o botão "Gerar Relatórios" for pressionado
function iniciarProcesso() {
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "main",
    },
    url: minhaUrl,
    success: function (data) {
      console.log("Dados recebidos:", data);
      updateTableData(data);
    },
    error: function (err) {
      console.error("Erro:", err);
    },
  });
}

// REALIZAR O FILTRO COM AJAX
function populainpuntControlNumbers() {

  var dateFilterDropdownElement = document.getElementById("dateFilterDropdown");

  if (dateFilterDropdownElement) {
    var dateFilterDropdown = dateFilterDropdownElement.value;
    // Restante do seu código
  } else {
    console.error("Elemento 'dateFilterDropdown' não encontrado.");
  }

  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "matchedValues",
      filtro: dateFilterDropdown,
    },
    url: minhaUrl,
  }).done(function (data) {
    // RESULTADO FRONT
    try {
      var data = JSON.parse(data);
    } catch (error) {
      console.error("Erro ao analisar JSON:", error);
    }
  }).fail(function (jqXHR, textStatus, errorThrown) {
    console.error("Erro na requisição AJAX:", textStatus, errorThrown);
  });
}

function myEditor(cell, onRendered, success, cancel) {
  var editor = document.createElement("input");

  // Se o valor da célula for "undefined", defina o valor do editor como vazio.
  // Caso contrário, use o valor atual da célula.
  editor.value = cell.getValue() === "undefined" ? "" : cell.getValue();

  onRendered(function () {
    editor.focus();
    editor.style.width = "100%";
  });

  // Quando o editor perder o foco (quando o usuário clica fora dele),
  // retorne o valor do editor para a célula.
  editor.addEventListener("blur", function (e) {
    success(editor.value);
  });

  return editor;
}

// CONTINUAR ENVIANDO DADOS PARA CHAT A PARTE DAQUI 28.08
function popularTabela(data) {
  // Converte o array 2D em um array de objetos para o Tabulator
  const formattedData = data.map((row) => {
    return {
      dataEntrada: row[0],
      numControle: row[1],
      cliente: row[2],
      descricao: row[3],
      nota: row[4],
      idPCP: row[5],
      referenciaProducao: row[6],
      qtd: row[7],
      op: row[8],
      cod: row[9],
      observacao: row[row.length - 1],
    };
  });

  table_checklist.setData(formattedData);
}

function filterUniqueByIdPCP(data) {
  const uniqueEntries = {};

  data.forEach((entry) => {
    if (!uniqueEntries[entry.idPCP]) {
      uniqueEntries[entry.idPCP] = entry;
    }
  });

  return Object.values(uniqueEntries);
}

if (table_checklist && typeof table_checklist.setSort === 'function') {
  table_checklist.setSort([
    { column: "dtProducao", dir: "asc" },
    { column: "SEQ", dir: "asc" },
    { column: "OP", dir: "asc" }
  ]);
} else {
  console.error("O objeto table_checklist não está corretamente inicializado ou a função setSort não é suportada.");
}


// CLASSIFICAÇÃO DA TABELA
// Função para comparar a coluna Dt Produção
function compareDtProducao(a, b) {
  const cellA = a.children[12].textContent.trim();
  const cellB = b.children[12].textContent.trim();

  // Colocar "-" primeiro
  if (cellA === "-" && cellB !== "-") return -1;
  if (cellA !== "-" && cellB === "-") return 1;

  // Se ambas são "-", não há diferença
  if (cellA === "-" && cellB === "-") return 0;

  const dateA = new Date(cellA);
  const dateB = new Date(cellB);

  return dateA - dateB;
}

function customSEQSorter(a, b) {
  //function compareSeq(a, b) {
  // Se ambos os valores são vazios ou "undefined", considere-os iguais
  if ((!a && !b) || (a === "undefined" && b === "undefined")) return 0;

  // Se 'a' é vazio ou "undefined", 'a' é considerado maior (para que fique no final)
  if (!a || a === "undefined") return 1;

  // Se 'b' é vazio ou "undefined", 'b' é considerado maior (para que fique no final)
  if (!b || b === "undefined") return -1;

  // Finalmente, retorne a comparação dos dois números
  return parseInt(a, 10) - parseInt(b, 10);
}

function compareOp(a, b) {
  const cellA = a.children[8].textContent.trim();
  const cellB = b.children[8].textContent.trim();

  // Se forem iguais, retorne 0
  if (cellA === cellB) return 0;

  // Compare com base na ordem definida em OPERATIONS_ORDER
  const indexA = OPERATIONS_ORDER.indexOf(cellA);
  const indexB = OPERATIONS_ORDER.indexOf(cellB);

  // Caso algum valor não seja encontrado na lista, considere-o como de menor prioridade
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;

  return indexA - indexB;
}

// FINAL DA CLASSIFICAÇÃO DA TABELA
function populateFilterDropdown(dropdownId, values) {
  const dropdown = document.getElementById(dropdownId);
  if (dropdown) {
    dropdown.innerHTML = "";
    values.forEach((value) => {
      let option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      dropdown.appendChild(option);
    });
  } else {
    console.error("Dropdown não encontrado:", dropdownId);
  }
}

function sendDataToServer(id, action) {
  $.ajax({
    type: "POST",
    data: {
      url: minhaUrl,
      qualFuncao: "getDadosPorNumeroControles",
      id: id,
      action: action,
    },
  })
    .done(function (data) {
      // RESULTADO FRONT
      try {
        var data = JSON.parse(data);
      } catch (error) {
        console.error("Erro ao analisar JSON:", error);
      }
      console.log("Depois da função coletarDadosDaInterface");
    })
    .fail(function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na chamada AJAX:", textStatus, errorThrown);
    });
}

// CHAMADO LADO DO GAS
function fetchDataAndPopulate() {
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "getDataForTable",
    },
    url: minhaUrl,
    success: function (responseData) {
      try {
        var data = JSON.parse(responseData);
      } catch (e) {
        console.error("Erro ao analisar a resposta JSON:", e);
      }
    },
    error: function (err) {
      console.error(err);
    },
  });
}

// SALVA OS DADOS INPUNTS
function salvarDadosNaFolha() {
  var dadosInterface = coletarDadosDaInterface();

  console.log(dadosInterface);

  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "salvarDadosProgramacaoPCP",
      dados: dadosInterface,
    },
    url: minhaUrl,
    success: function () {
      alert("Dados salvos com sucesso!");
    },
    error: function (err) {
      alert("Erro ao salvar dados: " + err.statusText);
    },
  });
}

// Callbacks para lidar com a resposta do GAS
function onUpdateSuccess(response) {
  alert("Atualizado com sucesso!");
  // Aqui, você pode adicionar código para atualizar sua tabela no lado do cliente se necessário.
}

function onUpdateFailure(error) {
  alert("Erro ao atualizar: " + error);
}

function closeEditModal() {
  var modal = document.getElementById("editModal");
  modal.style.display = "none";
}

// DATA
function formatDate(dateObj) {
  var day = String(dateObj.getDate()).padStart(2, "0");
  var month = String(dateObj.getMonth() + 1).padStart(2, "0"); // Os meses são de 0 a 11, então adicionamos 1
  var year = dateObj.getFullYear();

  return `${day}/${month}/${year}`;
}

function formatDateProducao(inputDate) {
  const parts = inputDate.split("-");
  return `${parts[2]}/${parts[1]}/${parts[0]}`;
}

function clientTestFunction() {
  var testNumeroControle = "0009-23"; // Use o mesmo valor que funcionou no teste do servidor

  console.log("Testando com número de controle:", testNumeroControle);

  google.script.run
    .withSuccessHandler(function (data) {
      console.log("Data recebida:", data);
    })
    .withFailureHandler(function (error) {
      console.error("Erro:", JSON.stringify(error));
    })
    .getDadosPorNumeroControle(testNumeroControle);
}

function openPDF(url) {
  window.open(url, "_blank");
}

function generatePDF(dataUsuario) {
  google.script.run
    .withSuccessHandler(function (data) {
      if (data.link) {
        window.open(data.link, "_blank");
      } else if (data.error) {
        alert("Erro: " + data.error);
      }
    })
    .withFailureHandler(function (error) {
      console.error("Erro ao fazer requisição:", error);
    })
    .generatePDF(dataUsuario);
}

function generateMultiplePDFs(operations) {
  google.script.run
    .withSuccessHandler(function (data) {
      if (data.links && Array.isArray(data.links)) {
        data.links.forEach((link) => {
          window.open(link, "_blank");
        });
      } else if (data.error) {
        alert("Erro: " + data.error);
      }
    })
    .withFailureHandler(function (error) {
      console.error("Erro ao fazer requisição:", error);
    })
    .generateMultiplePDFs(operations);
}

// AMOSTRAR OS PDF GERADOS LADO DO CLIENTE
function extractURLs(text) {
  const regex = /(https:\/\/drive\.google\.com\/[^, ]+)/g;
  const urls = [];
  let match;

  while ((match = regex.exec(text))) {
    urls.push(match[1]);
  }

  return urls;
}

// ---------- Funções de inicialização ----------

function onPaginaCarregada() {
  //fetchAndPopulateControlNumbers(); // Iniciar numero controle
  //buscarDadosIniciaisConferenciaProgramacao();
  Relatorio_Checklits_pedentes_Inicial();
  selecionar_numeroControle(); // Iniciar numero controle
  //populainpuntControlNumbers(); // PopularControles
}

function formatDateToDDMMYYYY(date) {
  const day = String(date.getDate()).padStart(2, "0"); // Garante que o dia tenha dois dígitos
  const month = String(date.getMonth() + 1).padStart(2, "0"); // Garante que o mês tenha dois dígitos
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}


function setupEventListeners() {
  console.log("Configurando ouvintes de eventos...");
  // Adiciona o evento de mudança ao checkbox de seleção total
  document.querySelector("#selectAllCheckbox");

  // Adiciona evento de input para filtrar a tabela de acordo com os campos de entrada
  document
    .querySelector("#numeroControle")
    .addEventListener("input", filterTableByInput);

   // Adiciona evento de clique ao select
  document
    .querySelector("#numeroControle")  // Substitua "seuSelectId" pelo ID real do seu elemento select
    .addEventListener("click", handleSelectClick);
}
function handleSelectClick() {
  // Verifica se o valor do campo de entrada está vazio
  const numControleValue = document.querySelector("#numeroControle").value.trim();

  // Verifica se o usuário clicou em uma opção específica ou apagou todos os dados
  if (numControleValue) {
    // Se numControle tem valor, limpe o campo de entrada
    document.querySelector("#numeroControle").value = "";
  } else {
    // Se o numControle estiver vazio, traga de volta a lista original
    Relatorio_Checklits_pedentes_Inicial();
    table_checklist.clearFilter(); // Certifique-se de remover todos os filtros para exibir todos os registros
  }
}

function filterTableByInput(event) {
  console.log("filterTableByInput");

  let filters = [];
     numControleValue = document
    .querySelector("#numeroControle")
    .value.trim();

  if (numControleValue) {
    // Se numControle tem valor, filtre apenas por numControle
    filters.push({
      field: "numControle",
      type: "like",
      value: numControleValue,
    });
    
    // Aplica os filtros ao Tabulator
    table_checklist.setFilter(filters);
    console.log("Filtros aplicados:", filters);

    // Se não houver registros na tabela após filtrar e o numControleValue não estiver vazio, busque no GAS
    if (!tableHasRecords()) {
      console.log('teste')
      buscarNoGAS(numControleValue);
    }
  } else {
    // Se o numControle estiver vazio, traga de volta a lista original
    Relatorio_Checklits_pedentes_Inicial();
    table_checklist.clearFilter(); // Certifique-se de remover todos os filtros para exibir todos os registros
  }
}

function tableHasRecords() {
  // Obter todas as linhas
  const allRows = table_checklist.getRows();

  // Verificar se há algum filtro aplicado
  const isFilterActive = table_checklist.getFilters().length > 0;

  if (isFilterActive) {
    // Se há filtro, verificar se pelo menos uma linha é visível
    const hasVisibleRows = allRows.some(row => row.getData().visible);

    if (!hasVisibleRows) {
      console.log('Nenhum registro visível na tabela. Buscando no GAS...');
      buscarNoGAS(numControleValue);
    }

    return hasVisibleRows;
  } else {
    // Se não há filtro, verificar se há pelo menos uma linha na tabela
    const hasRows = allRows.length > 0;

    if (!hasRows) {
      console.log('Nenhum registro visível na tabela. Buscando no GAS...');
      buscarNoGAS(numControleValue);
    }

    return hasRows;
  }
}

function buscarNoGAS(numControleValue) {
  console.log("a");

  // Mostra a mensagem de carregamento antes de iniciar a chamada AJAX
  showLoadingMessage();

  var all_data = {
    numControleValue: numControleValue,
  };

  console.log(all_data);

  $.ajax({
    url: my_url() + "consultar_numero_controle_Checklist",
    data: JSON.stringify(all_data),
    contentType: 'application/json',
    type: 'POST',
  })
  .done(function (data) {
    try {
      let dados = data.retorno;
      console.log("buscarNoGAS:", dados);
      updateTableData(data);
    } catch (e) {
      console.error("Erro ao analisar os dados:", e);
    }
  })
  .fail(function (jqXHR, textStatus, errorThrown) {
    console.error("Erro na solicitação AJAX: " + errorThrown);
    console.error("Status da solicitação: " + textStatus);
    mostrarErro();
  })
  .always(function () {
    hideLoadingMessage(); // Esconde a mensagem de carregamento quando a chamada AJAX terminar, independentemente de ter sucesso ou falhar
  })
  .catch(function (error) {
  console.error("Erro inesperado:", error);
  mostrarErro();
});
}

function showLoadingMessage() {
  Swal.fire({
    title: "Aguarde...",
    text: "Buscando dados. Por favor, não feche esta janela.",
    icon: "info",
    showConfirmButton: false,
    allowOutsideClick: false,
  });
}

function hideLoadingMessage() {
  Swal.close();
}

// ---------- Funções relacionadas a AJAX e manipulação de respostas ----------

// ALIMENTAR LISTA NUMERO CONTROLE
function processarDadosConferencia(dados) {
  // Aqui, você pode processar os dados conforme necessário. Por exemplo:
  dados.forEach(function (item) {
    // Fazer algo com cada item, como adicionar a um elemento da página, etc.
    console.log("Processando item:", item);

    // Se você quiser adicionar ao datalist "numerosDeControle":
    var option = document.createElement("option");
    option.value = item;
    document.getElementById("numerosDeControle").appendChild(option);
  });
}

function teste() {
  console.log("Buscando teste...");

  $.ajax({
    url: my_url() + "dados_checklist_por_id",
    type: "POST",
    success: function (response) {
      try {
        let dados = response.retorno;
        console.log("carregarDadosPopulateControlNumbers:", dados);
      } catch (e) {
        console.error("Erro ao analisar os dados:", e);
      }
    },
    error: function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na solicitação AJAX: " + errorThrown);
      console.error("Status da solicitação: " + textStatus);
      mostrarErro();
    },
    beforeSend: function () {
      console.log("Enviando requisição para buscar números de controle...");
    },
    complete: function () {
      console.log("Requisição para buscar números de controle completada.");
    },
  });
}


function selecionar_numeroControle() {
console.log("selecionar__numeroControle");
$.ajax({
    url: my_url() + "numeroControles_Unicos",
    type: "POST",
    success: function (data) {
      console.log("carregarDadosPopulateControlNumbers:",data);

      try {
        let dados = data.retorno_especifico;
        console.log("carregarDadosPopulateControlNumbers:", dados);
        populateControlNumbers(dados); // Alteração aqui: passando 'dados' em vez de 'response'
      } catch (e) {
        console.error("Erro ao analisar os dados:", e);
      }
    },
    error: function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na solicitação AJAX: " + errorThrown);
      console.error("Status da solicitação: " + textStatus);
      mostrarErro();
    },
    beforeSend: function () {
      console.log("Enviando requisição para buscar números de controle...");
    },
    complete: function () {
      console.log("Requisição para buscar números de controle completada.");
    },
  });
}

function fetchAndPopulateControlNumbers() {
  console.log("Buscando números de controle...");

  $.ajax({
    url: my_url() + "numeroControles_Unicos",
    type: "POST",
    success: function (response) {
      try {
        let dados = response.retorno;
        console.log("carregarDadosPopulateControlNumbers:", dados);
        populateControlNumbers(dados); // Alteração aqui: passando 'dados' em vez de 'response'
      } catch (e) {
        console.error("Erro ao analisar os dados:", e);
      }
    },
    error: function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na solicitação AJAX: " + errorThrown);
      console.error("Status da solicitação: " + textStatus);
      mostrarErro();
    },
    beforeSend: function () {
      console.log("Enviando requisição para buscar números de controle...");
    },
    complete: function () {
      console.log("Requisição para buscar números de controle completada.");
    },
  });
}

/**
 * Popula os números de controle em um datalist.
 */
 function populateControlNumbers(data) {
  // Tentativa de analisar como JSON se os dados são uma string
  if (typeof data === "string") {
    try {
      data = JSON.parse(data);
    } catch (e) {
      console.error("Erro ao analisar os dados:", e);
      return;
    }
  }

  // Verifique se os dados são uma instância de um Array
  if (!Array.isArray(data)) {
    console.error(
      "Dados recebidos na função populateControlNumbers não são uma instância de Array:",
      data
    );
    return;
  }

  console.log("Populando datalist com números de controle...");
  console.log(data);

  var datalist = document.getElementById("numerosDeControle");
  datalist.innerHTML = ""; // Limpa qualquer opção anterior

  // Agora, usando a variável 'data' em vez de 'numbers'
  data.forEach(function (item) {
    var option = document.createElement("option");
    option.value = item.ID_Ordem; // Assumindo que 'ID' é a propriedade desejada
    option.setAttribute("data-id-ordem", item.ID_Ordem); // Adicionando atributo de dados para ID_Ordem
    datalist.appendChild(option);
  });
}

function fetchAndpopulatePedidoNumbers() {
  console.log("Buscando números de controle...");

  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "controlePedidos",
    },
    url: minhaUrl,
    success: function (response) {
      try {
        populatePedidoNumbers(response);
      } catch (e) {
        console.error("Erro ao popular números de controle:", e.message);
      }
    },
    error: function (jqXHR, textStatus, errorThrown) {
      console.error(
        "Erro ao buscar números únicos de controle:",
        errorThrown
      );
    },
    beforeSend: function () {
      console.log(
        "Enviando requisição para buscar números de controle..."
      );
    },
    complete: function () {
      console.log(
        "Requisição para buscar números de controle completada."
      );
    },
  });
}

/**
 * Manipula erros das chamadas AJAX.
 */
function handleAjaxError(jqXHR, textStatus, errorThrown) {
  console.error("Erro AJAX:", textStatus, errorThrown);
}

/**
 * Manipula a resposta da chamada AJAX para os números de controle.
 */
function handleControlNumbersResponse(data) {
  console.log("Dados recebidos em handleControlNumbersResponse:", data);

  if (Array.isArray(data)) {
    console.log("Os dados são uma array.");
    if (data.every((item) => typeof item === "string")) {
      console.log("Todos os itens na lista são strings.");
      // Chame a função para processar os dados aqui.
    } else {
      console.warn("Nem todos os itens na lista são strings.");
    }
  } else {
    console.warn("Os dados não são uma array.");
  }
}

/**
 * Faz uma chamada AJAX para buscar dados iniciais de conferência de programação.
 */
function buscarDadosIniciaisConferenciaProgramacao() {
$.ajax({
  url: my_url() + "conferencia_programacao_dados_iniciais_Checklist",
})
.done(function (data) {
  try {
      let dados = data.retorno;
      console.log("carregarDadosFuncionario:", dados);
      updateTableData(data);
  } catch (e) {
      console.error("Erro ao analisar os dados:", e);
  }
})
.fail(function (jqXHR, textStatus, errorThrown) {
  console.error("Erro na solicitação AJAX: " + errorThrown);
  console.error("Status da solicitação: " + textStatus);
  mostrarErro();
});
}


// ---------- Funções de manipulação DOM ----------

/**

/**
 * Popula o dropdown com operações.
 */
function populateOperations() {
  console.log("Populando operações...");
  const operationsSelect = $("#operacaoSelect");

  OPERATIONS_ORDER.forEach((op) => {
    let option = $("<option>").val(op).text(op);
    operationsSelect.append(option);
  });
}

/**
 * Filtra as linhas da tabela com base nos valores dos inputs.
 */

function updateHeaderCheckboxState() {
  const selectedRows = table_checklist.getSelectedRows();
  const allRows = table_checklist.getRows();
  const headerCheckbox = document.querySelector("#selectAllCheckbox");

  if (selectedRows.length === allRows.length) {
    // Todos selecionados
    headerCheckbox.checked = true;
    headerCheckbox.indeterminate = false;
  } else if (selectedRows.length > 0) {
    // Alguns selecionados
    headerCheckbox.checked = false;
    headerCheckbox.indeterminate = true;
  } else {
    // Nenhum selecionado
    headerCheckbox.checked = false;
    headerCheckbox.indeterminate = false;
  }
}

function iniciarLoader() {
  Swal.fire({
    title: "Carregando...",
    html: "Por favor, aguarde enquanto os dados estão sendo processados.",
    allowOutsideClick: false,
    onBeforeOpen: () => {
      Swal.showLoading();
    },
  });
}

function encerrarLoader() {
  Swal.close();
}

function errorFunction(jqXHR, textStatus, errorThrown) {
  console.error("Erro na chamada AJAX:", textStatus, errorThrown);
  console.log("HTTP Status:", jqXHR.status);
  console.log("Resposta do Servidor:", jqXHR.responseText);
}

// ALERTA PERSONALIZADO
function mostrarAlerta() {
  // Primeira pergunta: "Deseja realmente salvar as alterações?"
  Swal.fire({
    title: "Você tem certeza?",
    text: "Deseja realmente salvar as alterações?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#3085d6",
    cancelButtonColor: "#d33",
    confirmButtonText: "Sim, salvar!",
    cancelButtonText: "Não, cancelar!",
  }).then((result) => {
    if (result.isConfirmed) {
      // Se o usuário clicar em "Sim, salvar!"

      const idsToDelete = updateSelectedIDs(); // Pega os IDs das linhas selecionadas

      console.log("IDs a serem deletados:", idsToDelete);

      if (idsToDelete.length > 0) {
        // Segunda pergunta: "Deseja deletar as linhas selecionadas antes de salvar?"
        Swal.fire({
          title: "Deletar Linha?",
          text: "Deseja deletar as linhas selecionadas antes de salvar?",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Sim, deletar!",
          cancelButtonText: "Não, continuar!",
        }).then((deleteResult) => {
          if (deleteResult.isConfirmed) {
            // Se o usuário clicar em "Sim, deletar!"
            deletarLinhas(idsToDelete);
          }
          salvarAlterarSeguenciaProducao();

          // Alerta informando que os dados foram atualizados com sucesso
          Swal.fire({
            title: "Sucesso!",
            text: "Os dados foram atualizados com sucesso.",
            icon: "success",
          });
        });
      } else {
        salvarAlterarSeguenciaProducao();

        // Alerta informando que os dados foram atualizados com sucesso
        Swal.fire({
          title: "Sucesso!",
          text: "Os dados foram atualizados com sucesso.",
          icon: "success",
        });
      }
    }
  });
}

// Função para pegar os IDs das linhas selecionadas
function getselectedIDs() {
  const selectedRows = table.getSelectedRows(); // Pega todas as linhas selecionadas na tabela Tabulator

  selectedRows.forEach((row) => {
    const rowData = row.getData();
    selectedIDs.push(rowData.idPCP); // Assumindo que 'idPCP' é o nome do campo que contém o ID
  });

  return selectedIDs;
}

// Modificamos a função deletarLinhas para aceitar os IDs como um argumento
function deletarLinhas() {
  const idsToDelete = getselectedIDs();

  // Verifique se o array 'idsToDelete' contém algum ID. Se estiver vazio, interrompa a função.
  if (!idsToDelete.length) {
    console.warn("Nenhum ID fornecido para exclusão.");
    return;
  }

  console.log("IDs a serem deletados:", idsToDelete);

  // Use o AJAX para enviar os dados
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "deletarLinhasNovasTarefas",
      ids: JSON.stringify(idsToDelete), // Envie os IDs como JSON
    },
    url: minhaUrl,
  })
    .done(function (response) {
      try {
        var data = JSON.parse(response);
        if (data.success) {
          console.log("Linhas deletadas com sucesso:", data);
        } else {
          console.warn("Erro ao deletar linhas:", data.message);
        }
      } catch (error) {
        console.error("Erro ao analisar a resposta JSON:", error);
      }
    })
    .fail(function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na chamada AJAX:", textStatus, errorThrown);
    });
}

// SALVAR ALTERAÇÕES NA TABELA
function salvarAlterarSeguenciaProducao() {
  // Pegar todas as linhas de dados da tabela Tabulator
  const rows = table_checklist.getData();
  // Capturar e formatar o valor do input dataLancamento
  const dataLancamentoValue = formatarData(
    document.querySelector("#dataLancamento").value
  );

  // Array para armazenar as informações capturadas
  let dataToSave = [];

  rows.forEach((row) => {
    const rowData = [];

    // Adicionar o ID como primeiro elemento no array de dados
    rowData.push(row.idPCP);

    // Colunas específicas que você listou
    const colunasEspecificas = [
      "Orç",
      "pedido",
      "SEQ",
      "descricao",
      "dtProducao",
      "prazoEntrega",
      "observacao",
    ];

    colunasEspecificas.forEach((coluna) => {
      rowData.push(row[coluna]);
    });

    // Adicionar o valor de dataLancamento ao final do rowData
    rowData.push(dataLancamentoValue);

    // Adicionar os dados da linha ao array principal
    dataToSave.push(rowData);
  });

  dataToSave = dataToSave.map((row) => {
    return row.map((cellValue) => {
      return cellValue === undefined ? "" : cellValue;
    });
  });

  console.log("Dados a serem enviados para o GAS:", dataToSave);

  // Use o AJAX para enviar os dados
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "salvarAlterarSeguenciaProducao",
      dataToSave: JSON.stringify(dataToSave), // Envie os dados como JSON
    },
    url: minhaUrl,
  })
    .done(function (data) {
      // RESULTADO FRONT
      try {
        var data = JSON.parse(data);
        console.log("Dados enviados com sucesso:", data);
        onPaginaCarregada(); // Atualizar a página
      } catch (error) {
        console.error("Erro ao analisar JSON:", error);
      }
    })
    .fail(function (jqXHR, textStatus, errorThrown) {
      console.error("Erro na chamada AJAX:", textStatus, errorThrown);
    });
}

function enviarDadosParaServidor() {
  //var dadosModal = coletarDadosDoModal();

  console.log("Resposta do Servidor:", dadosModal);
  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "atualizarFolhas",
      dados: JSON.stringify(dadosModal),
    },
    url: minhaUrl,
  })
    .done(function (response) {
      // Verifique a resposta do servidor e decida se deseja fechar o modal
      if (response.success) {
        // Feche o modal e recarregue a página
        dialog.close();
        location.reload();
      } else {
        console.error("Erro ao atualizar folhas:", response.message);
      }
    })
    .fail(errorHandlingFunction);
}

function errorHandlingFunction(jqXHR, textStatus, errorThrown) {
  console.error("Erro na chamada AJAX:", textStatus, errorThrown);
}

document.querySelector(".close").addEventListener("click", function () {
  const modal = document.querySelector(".mdl-dialog");
  modal.close();
});

function updateCheckboxVisualState(checkboxElement) {
  const spanElement = checkboxElement.nextElementSibling; // Pega o <span> após o checkbox

  if (checkboxElement.checked) {
    spanElement.style.backgroundColor = "#2196F3"; // A cor quando o checkbox estiver marcado
    spanElement.textContent = "✅"; // Unicode para o sinal de visto
  } else {
    spanElement.style.backgroundColor = "white"; // A cor padrão do checkbox
    spanElement.textContent = "☐"; // Unicode para uma caixa vazia
  }
}

function sendDataToBackend(ids, date) {
  // Convertendo todos os IDs para números:
  ids = ids.map((id) => Number(id));

  console.log("Enviando dadosSS: ", { ids: ids, date: date });

  $.ajax({
    type: "POST",
    data: {
      qualFuncao: "lancamentoProducao",
      selectedData: JSON.stringify({ ids: ids, date: date }),
    },
    url: minhaUrl,
  })
    .done(function (response) {
      console.log("TONUY: ", response);
      try {
        var data = JSON.parse(response);
        if (data.success) {
          /*Swal.fire({
                  title: "Sucesso!",
                  text: "Baixa Serviços realizada com Sucesso.",
                  icon: "success",
                  confirmButtonColor: "#3085d6",
                  confirmButtonText: "Entendi!",
                }); */
        } else {
          handleError(
            "Ocorreu um erro ao atualizar a data: " + data.message
          );
        }
      } catch (error) {
        console.error("Erro ao analisar a resposta JSON:", error);
      }
    })
    .fail(function (jqXHR, textStatus, errorThrown) {
      handleError(
        "Ocorreu um erro ao se comunicar com o servidor: " + textStatus
      );
      console.error("Erro na chamada AJAX:", textStatus, errorThrown);
    });
}

function lancamentoProducao() {
  updateSelectedIDs();

  if (!selectedIDs.length) {
    Swal.fire({
      title: "Atenção!",
      text: "Selecione ao menos uma linha antes de realizar o Baixa da Produção.",
      icon: "warning",
      confirmButtonColor: "#3085d6",
      confirmButtonText: "Entendi!",
    });
    return;
  }

  let summaryHTML = buildSummaryHTML(selectedRowsData);

  // Solicitando a data de produção através de um modal
  Swal.fire({
    title: "Baixa da Produção",
    html: `
            <div style="text-align: left; margin-bottom: 15px;">
                ${summaryHTML}
            </div>
            <strong>Data de Lançamento:</strong>
            <input type="date" id="swal-input-date" class="swal2-input" value="${
              new Date().toISOString().split("T")[0]
            }">
        `,
    showCancelButton: true,
    confirmButtonText: "Confirmar",
    cancelButtonText: "Cancelar",
    focusConfirm: false,
    preConfirm: () => {
      let date = document.getElementById("swal-input-date").value;
      if (!date) {
        Swal.showValidationMessage("Por favor, selecione uma data!");
      }
      let formattedDate = formatDateProducao(date); // Formatação da data
      return formattedDate;
    },
  }).then((result) => {
    if (result.isConfirmed) {
      try {
        updateTableWithDate(selectedRowsData, result.value);
        sendDataToBackend(selectedIDs, result.value);
      } catch (error) {
        console.error("Erro ao processar a data de lançamento:", error);
      }
    }
  });
}

function updateTableWithDate(selectedRowsData, date) {
  try {
    selectedRowsData.forEach((data) => {
      let row = data.row;
      let rowData = row.getData();
      rowData.dtProducao = date;
      row.update(rowData);
    });
    console.log("Tabela atualizada com a data de lançamento");
  } catch (error) {
    console.error("Erro ao atualizar a tabela com a data:", error);
  }
}

function buildSummaryHTML(selectedRowsData) {
  // Primeiro, agrupamos os dados
  const groupedData = {};

  selectedRowsData.forEach((data) => {
    let rowData = data.row.getData();
    let controlNum = rowData.numControle || "N/A";
    let operation = rowData.op || "N/A";

    if (!groupedData[controlNum]) {
      groupedData[controlNum] = {};
    }

    if (!groupedData[controlNum][operation]) {
      groupedData[controlNum][operation] = [];
    }

    groupedData[controlNum][operation].push(rowData);
  });

  // Agora, criamos o HTML usando os dados agrupados
  let summaryHTML = '<div style="font-size: 16px;">';

  Object.keys(groupedData).forEach((controlNum) => {
    summaryHTML += `<div style="font-weight: bold; font-size: 18px; margin-top: 15px;">Número de Controle: ${controlNum}</div>`;

    Object.keys(groupedData[controlNum]).forEach((operation) => {
      summaryHTML += `
                <div style="margin-left: 15px;">
                    <div style="font-weight: bold; font-size: 17px; margin-top: 10px;">Operação: ${operation}</div>
                    ${groupedData[controlNum][operation]
                      .map(
                        (data) => `
                        <div style="border: 1px solid #e1e1e1; margin: 5px 0; padding: 5px; border-radius: 5px; background-color: white;">
                            <div><strong>Código:</strong> ${
                              data.cod || "N/A"
                            }</div>
                            <div><strong>Descrição:</strong> ${
                              data.descricao || "N/A"
                            }</div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
    });
  });

  summaryHTML += "</div>";

  return summaryHTML;
}

function muda_de_tela(url, event) {
      window.location.href = url;
      event.stopPropagation();
    }

// ........................................//........................//...................

// CHAMAR A NOVA TABELA
function updateTableData(data) {
  if (table_checklist) {
    const transformedData = transformData(data);
    const currentData = table_checklist.getData();
    const newData = transformedData.map(transformedRow => {
      const matchingRow = currentData.find(row => row.Id_funcionario === transformedRow.Id_funcionario);
      return matchingRow ? { ...matchingRow, ...transformedRow } : transformedRow;
    });
    table_checklist.setData(newData);
  } else {
    console.error("Tabela não inicializada!");
  }
}

// CARREGAR INFORMAÇÃO CHECKLIST VINDO DO FLASK

    function transformedData_Recebimento_pedentes(data) {
    console.log("Dados de entrada para transformação:", data);

    const mappedColumns_Recebimento_pedentes = {
        Cod_Produto: "codProduto",
        DataCadastro: "dataCadastro",
        DataRec_OrdemServiços: "dataRecOrdemServicos",
        HoraInicial_Ordem: "horaInicialOrdem",
        ID: "id",
        ID_Componente: "idComponente",
        ID_Ordem: "idOrdem",
        ID_PostoTrabalho: "idPostoTrabalho",
        ID_Vendedor: "idVendedor",
        ID_cliente: "idCliente",
        Id: "idGeral",
        Nome_cliente: "nomeCliente",
        NotaInterna: "notaInterna",
        QUEIXA_CLIENTE: "queixaCliente",
        Qtd_Produto: "qtdProduto",
        Referencia_Produto: "referenciaProduto",
        Status_Ordem: "statusOrdem",
        TipoOrdem: "tipoOrdem",
        Usuario_Cadastro: "usuarioCadastro",
        idGrupo: "idGrupo",
        idoperacaoServico: "idOperacaoServico",
        nome: "nome",
        nome_produto: "nomeProduto"
        // Adicione ou remova colunas conforme necessário
    };

    if (!data || !Array.isArray(data)) {
        console.error("Dados inválidos fornecidos para transformação:", data);
        return [];
    }
      
    const transformed_Recebimento_pedentes = data.map((row) => {
        const transformedRow_Recebimento_pedentes = {};

        for (const columnFrom_Recebimento_pedentes in mappedColumns_Recebimento_pedentes) {
            const columnName = mappedColumns_Recebimento_pedentes[columnFrom_Recebimento_pedentes];
            if (columnFrom_Recebimento_pedentes in row) {
                transformedRow_Recebimento_pedentes[columnName] = row[columnFrom_Recebimento_pedentes];
            } else {
                // Mantém a propriedade, mas define como string vazia
                transformedRow_Recebimento_pedentes[columnName] = "";
            }
        }

        // Inclua a coluna "idPCP" com o valor original "id"
        transformedRow_Recebimento_pedentes["idPCP"] = row["id"];

        return transformedRow_Recebimento_pedentes;
    });

    console.log("Dados transformados:", transformed_Recebimento_pedentes);
    return transformed_Recebimento_pedentes;
}

// Função para carregar a lista de obras
function Relatorio_Checklits_pedentes_Inicial() {
console.log('Relatorio_Checklits_pedentes')
try {
    $.ajax({
        url: my_url() + "selecionar_novos_produtos",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
        }),
    })
    .done(function (data) {
      //let dados = data.checklist_resumido;
      let dados_resumidos = data.checklist_resumido;
      let dados_especificos = data.retorno_especifico;
      let dados_novos_produtos = data.novos_produtos;

      console.log("Dados Checklists Resumidos:", dados_resumidos);
      console.log("Dados Checklists Específicos:", dados_especificos);
      console.log("Dados Checklists Específicos:", dados_novos_produtos);
      
      //console.log("carregarDados Checklists_especificos:", dados);
      //updateTableData(data);
    })
    .fail(function (xhr, status, error) {
        console.error("Erro ao buscar dados consolidados:", error);
        console.log("Status da requisição:", status);
        console.log("Resposta do servidor:", xhr.responseText);
    });
} catch (error) {
    console.error("Erro ao executar a função: " + error);
}
}
 // Função para obter detalhes do produto
 function obterDetalhesProduto(codigoProduto) {
        // Faça uma requisição AJAX para obter os detalhes do produto
        $.ajax({
            url: "/obter_detalhes_produto",  // Substitua pelo URL apropriado no Flask
            method: "POST",
            data: {codigoProduto: codigoProduto},
            success: function (data) {
                // Atualize os campos com os dados obtidos
                $("#descricaoProduto").val(data.nome_produto);
                $("#operacao").val(data.nome);
            },
            error: function (error) {
                console.log("Erro ao obter detalhes do produto:", error);
            }
        });
    }

// Função para carregar a lista de obras
function Relatorio_Checklits_pedentes() {
    console.log('Relatorio_Checklits_pedentes')

    VAR = ID_Recebimento = '18'
    
    console.log("ID_Recebimento:", ID_Recebimento);

    try {
        $.ajax({
            url: my_url() + "selecionar_checklists_especificos_Recebimento",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              "ID_Recebimento":ID_Recebimento,
            }),
        })
        .done(function (data) {
            console.log('Relatorio_Checklits_pedentes', data);
            // Antes de processar os dados na resposta AJAX
            if (data && data.retorno_especifico) {
                // Transforme os dados uma vez e armazene em uma variável
                const transformedData = transformedData_Recebimento_pedentes(data.retorno_especifico);

                // Chame a função de atualização da tabela com os dados transformados
                updateTableChecklist_pedentes(transformedData);

                console.log("Após chamar a função de atualização da tabela");
             } else {
                console.error("Resposta JSON inválida ou ausente");
            }
        })
        .fail(function (xhr, status, error) {
            console.error("Erro ao buscar dados consolidados:", error);
            console.log("Status da requisição:", status);
            console.log("Resposta do servidor:", xhr.responseText);
        });
    } catch (error) {
        console.error("Erro ao executar a função: " + error);
    }
}

function updateTableChecklist_pedentes(retorno_especifico) {
    console.log('Dados detalhados recebidos:', retorno_especifico);

    if (!Table_Checklist_pedentes) {
        console.log('Tabela não existe. Inicializando...');
        initializeTable_Checklist_pedentes();
    }

    // Adicione este log para verificar a existência da tabela
    console.log('Tabela existe:', Table_Checklist_pedentes);

    Table_Checklist_pedentes.setData(retorno_especifico);
}


  function initializeTable_Checklist_pedentes() {
  Table_Checklist_pedentes = new Tabulator("#Table_Checklist_pedentes", {
      pagination:"local",
      paginationSize:300,
      paginationInitialPage: 1,
      movableColumns:true,
      paginationButtonNext: "<i class='fas fa-chevron-right'></i>", // Ícone para próximo
      paginationButtonPrev: "<i class='fas fa-chevron-left'></i>", // Ícone para anterior
      name: "Table_Checklist_pedentes",
      deferRender: true,
      scrollCollapse: true,
      scroller: true,
      scrollY: 200,
      data: [],
        // Classificação inicial
        initialSort: [
        { column: "dtProducao", dir: "asc" },
        { column: "SEQ", dir: "asc" },
        { column: "op", dir: "asc" },
      ],
      columns: [
        {
            title: "Nº Controle",
            field: "idOrdem",
            hozAlign: "center",
            responsive: 0,
            },

            {
            title: "Data Recebimento",
            field: "dataCadastro", 
            hozAlign: "center",
            responsive: 0,
          },
            {
            title: "Cliente",
            field: "nomeCliente", 
            hozAlign: "center",
            responsive: 0,
          },
        {
          title: "Cód",
          field: "codProduto",
          hozAlign: "center",
          responsive: 0,
        },
        {
          title: "Qtda",
          field: "qtdProduto",
          hozAlign: "center",
          responsive: 0,
        },
        {
          title: "Desc Serviço/ Produto / Tarefa",
          field: "nomeProduto",
          hozAlign: "left",
          responsive: 0,
        },
        {
          title: "Nota",
          field: "notaInterna",
          hozAlign: "center",
          responsive: 0,
        },
        {
          title: "Referência Produto",
          field: "referenciaProduto",
          hozAlign: "center",
          responsive: 0,
        },
        {
          title: "Op",
          field: "op",
          hozAlign: "center",
          visible: false,
          responsive: 0,
        },
        {
          title: "Observação",
          field: "queixaCliente",
          hozAlign: "left",
          responsive: 0,
        },
         {
              title: "Id PCP",
              field: "id", // Certifique-se de que a chave corresponde ao objeto transformado
              hozAlign: "center",
              visible: false,
              responsive: 0,
          },
          {
              title: "Id PCP",
              field: "id", // Certifique-se de que a chave corresponde ao objeto transformado
              hozAlign: "center",
              visible: false,
              responsive: 0,
          },
      ],
      rowClick: function (e, row) {
          table_Presenca_FuncionarioDetalhamento.getRows().forEach(function (r) {
              r.getElement().classList.remove('selected');
          });

          row.getElement().classList.add('selected');
          var rowData = row.getData();
          preencherCamposDeEntrada(rowData);
      },
  });
  }


  function destruirTabela__Recebimento_pedentes() {
  if (Table_Checklist_pedentes) {
      Table_Checklist_pedentes.destroy();
      Table_Checklist_pedentes = null;
  }
  }         
          function preencherCamposDeEntrada(rowData) {
          console.log("Preenchendo campos de entrada:", rowData);
          // Defina o valor do campo idPCP usando JavaScript
          document.getElementById("idPCP").value = rowData.idPCP;
          document.getElementById("nomeCompleto").value = rowData.nomeCompleto;
        }
        
        
  // Adicione um evento de input ao campo de pesquisa
  $('#pesquisar_funcionario_Presenca_FuncionarioDetalhamento').on('input', function () {
  var valor_para_pesquisar = $(this).val().toLowerCase().trim();

  // Verifique se o valor de pesquisa não está vazio
  if (valor_para_pesquisar === "") {
      // Se estiver vazio, remova o filtro
      table_Presenca_FuncionarioDetalhamento.clearFilter();
  } else {
      // Se não estiver vazio, aplique o filtro
      table_Presenca_FuncionarioDetalhamento.setFilter(function (detalhado) {
          return (
              detalhado.idPCP.toLowerCase().includes(valor_para_pesquisar) ||
              detalhado.nomeCompleto.toLowerCase().includes(valor_para_pesquisar) ||
            
              data.formapag.toLowerCase().includes(valor_para_pesquisar)

              // Adicione mais colunas conforme necessário
          );
      });
  }
  });

// ..........................................//................////.........................////////...........................
  
  var processoConcluido = false;

  // Função para criar cópia do documento e processar os links
  function criar_copia_documentoTab3() {

      // Substitua os valores abaixo pelos dados corretos
      var modeloId = '1VIrF8PyUYe-DCIeDBv3Nmiy8if7pIPhl9zA7jM50PhE';
      var destinoId = '1fstEX_fgNPnzBEeu1szOvZ43AdMTPTjk';

      console.log('modeloId', modeloId);
      console.log('destinoId', destinoId);

      $.ajax({
          url: my_url() + "criar_copia_e_processar_documento",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
              "modelo_id": modeloId,
              "destino_id": destinoId,
          }),
      })
      .done(function (data) {
          console.log("Tipo da Resposta:", typeof data);
          console.log('data.resultados', data.resultados);

          // Exibir os links em algum lugar no seu front-end
          if (data.success === true && data.resultados.length > 0) {
              // Chamar a função para processar os links no ApScript
              console.log('Primeiro elemento de data.resultados', data.resultados[0]);
               processarLinksNoApScript();
          } else {
              // Ocultar o alerta de carregamento
              hideLoadingAlert();
              console.error("Nenhum link retornado pelo servidor.");
              exibirMensagemErro("Não foi possível processar os links, Favor tente apertar novamente Impr.");
  
          }
      })
      .fail(function (xhr, status, error) {
          console.error("Erro ao criar cópia do documento:", error);
          console.log("Status da requisição:", status);
          console.log("Resposta do servidor (falha):", xhr.responseText);

          // Se a resposta for um objeto, você pode tentar analisá-la manualmente
          try {
              var parsedData = JSON.parse(xhr.responseText);
              console.log("Resposta analisada manualmente:", parsedData);
          } catch (parseError) {
              console.error("Erro ao analisar manualmente a resposta:", parseError);
          }

          // Exibir mensagem de erro para o usuário
          exibirMensagemErro("Erro ao criar cópia do documento.");

            // Ocultar o alerta de carregamento
            hideLoadingAlert();
      });
  }

  // Função para mover o arquivo para a pasta destino e excluir o original
  function moverArquivoParaPasta(fileUrl, targetFolderId) {
      var fileId = getFileIdFromUrl(fileUrl);
      var targetFolder = DriveApp.getFolderById(targetFolderId);

      // Obter o arquivo pelo ID
      var file = DriveApp.getFileById(fileId);

      // Fazer uma cópia do arquivo na pasta destino
      var fileCopy = file.makeCopy(file.getName(), targetFolder);

      // Obter o link do arquivo copiado
      var copiedFileUrl = fileCopy.getUrl();

      // Excluir o arquivo original
      file.setTrashed(true);

      return copiedFileUrl;
  }

  function exibirLinksPDF(pdfLinks) {
    console.log("exibirLinksPDF");

      const linksContainer = $("#pdfLinksContainer");
      linksContainer.empty(); // Limpar links antigos

      pdfLinks.forEach((pdfInfo, index) => {
          const linkElem = $("<div>")
              .addClass("pdf-link-container");

          // Adicionar um ícone de PDF
          const pdfIcon = $("<span>")
              .addClass("mui-icon material-icons")
              .text("picture_as_pdf")
              .css({
                  marginRight: "5px",
                  color: "red",  // Cor do ícone PDF
              });
          linkElem.append(pdfIcon);

          // Adicionar o link de download
          const downloadLink = $("<a>")
              .attr("href", pdfInfo.pdfLink)
              .attr("target", "_blank")
              .attr("download", `${pdfInfo.nomeFuncionario || ""}_${index + 1}.pdf`)  // Utilizar nome do funcionário, ou "Funcionario" se o nome for indefinido
              .text(`Imprimir ou Visualizar ${pdfInfo.nomeFuncionario || ""}`)  // Utilizar nome do funcionário, ou nada se o nome for indefinido
              .addClass("pdf-link");
          linkElem.append(downloadLink);

          // Adicionar o nome do documento (pode ser o nome do funcionário)
          const documentName = pdfInfo.nomeFuncionario || "";  // Usar "Funcionario" se o nome for indefinido
          const documentNameElem = $("<span>")
              .text(documentName)
              .addClass("pdf-name");
          linkElem.append(documentNameElem);

          linksContainer.append(linkElem);
      });

      // Atualizar a variável para indicar que o processo está totalmente concluído
      processoConcluido = true;
      
      // Mostrar o contêiner com os links
      linksContainer.show();

      // Se o processo estiver totalmente concluído e todos os links foram exibidos, exibir mensagem adicional
      if (processoConcluido && pdfLinks.length > 0) {
          showSuccessAlert("Todos os PDFs foram processados com sucesso!");
      }
  }


// Função auxiliar para exibir mensagens de erro
function exibirMensagemErro(mensagem) {
    alert("Erro: " + mensagem);
}

// Função auxiliar para exibir mensagens para o usuário
function exibirMensagemUsuario(mensagem) {
    // Crie um elemento HTML para exibir a mensagem
    const mensagemElem = $("<div>")
        .text(mensagem)
        .css({
            padding: "10px",
            backgroundColor: "#4CAF50",
            color: "white",
            textAlign: "center"
        });

    // Adicione o elemento à página
    $("body").append(mensagemElem);

    // Remova a mensagem após alguns segundos (opcional)
    setTimeout(function() {
        mensagemElem.remove();
    }, 5000);
}


// ----------------------- PESQUISA -----------------------

function onProductSelected() {
    var productCode = document.getElementById("product-list").value;
    document.getElementById("product-search").value = productCode;  // Atualiza o campo de pesquisa com o código do produto selecionado
    console.log("fillProductList chamado com:", productCode);
    onProductCodeInput();  // Chama a função
}


        //  TESTE - FILTRAR O PRODUTO CONFORME DIGITADO
          function filterProducts(inputValue) {
          var filteredProducts = allProducts.filter(function(product) {
              // Verificando e convertendo para string
              var codigoStr = String(product.codigo || "");
              var nomeStr = String(product.nome || "");
              
              return nomeStr.toLowerCase().includes(inputValue.toLowerCase()) || 
                    codigoStr.toLowerCase().includes(inputValue.toLowerCase());
          });
          
          fillProductList(filteredProducts);  // Atualiza a lista de produtos
      }

             // FILTRAR O PRODUTO CONFORME DIGITADO
            function fillProductList(products) {
                var select = document.getElementById("product-list");
                select.innerHTML = "";
                for (var i = 0; i < products.length; i++) {
                    var option = document.createElement("option");
                    option.value = products[i].codigo;
                    option.text = products[i].codigo + " - " + products[i].nome;
                    select.appendChild(option);
                }
                document.getElementById("form").style.display = "block";
            }

function onProductCodeInput() {

  var productCode = document.getElementById("searchbar").value;

  // Log the productCode being sent
  console.log("Sending productCode to GAS:", productCode);

  fetchDataFromGAS('fetchAllProductDetails', productCode, function(data) {
    document.getElementById("product-description").value = data.description;
    document.getElementById("operation").value = data.operation;
    window.operationId = data.operationId;
    showOperationValue(data.operationValue);
  });
}


function selectProduct() {
  var selectedValue = document.getElementById("product-list").value;
  document.getElementById("searchbar").value = selectedValue;
  document.getElementById("form").style.display = "none";

  fetchDataFromGAS('fetchAllProductDetails', selectedValue, function(data) {
    document.getElementById("product-description").value = data.description;
    document.getElementById("operation").value = data.operation;
    window.operationId = data.operationId;
    showOperationValue(data.operationValue);
  });
}

function showOperationValue(value) {
    const resultValueElement = document.getElementById("result-value");
    const resultElement = document.getElementById("result");

    if (resultValueElement) {
        resultValueElement.textContent = value;
    } else {
        console.error("Elemento com ID 'result-value' não encontrado!");
    }

    if (resultElement) {
        resultElement.style.display = "none";
    } else {
        console.error("Elemento com ID 'result' não encontrado!");
    }
}


</script>
</html>